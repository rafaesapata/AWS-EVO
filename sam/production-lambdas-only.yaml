AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: |
  EVO Platform - Lambda Functions Only (194 total) - v18 add evo_app_credentials table + SSM permissions
  Uses existing VPC, RDS, Cognito infrastructure
  All functions use ARM64 + esbuild for fast builds
  Updated: 2026-02-12 - Add missing evo_app_credentials table migration + SSM PutParameter permission for Lambda role
Globals:
  Function:
    Runtime: nodejs20.x
    Timeout: 30
    MemorySize: 256
    Architectures:
      - arm64
    VpcConfig:
      SecurityGroupIds:
        - !Ref LambdaSecurityGroupId
      SubnetIds:
        - !Ref PrivateSubnet1Id
        - !Ref PrivateSubnet2Id
    Environment:
      Variables:
        NODE_PATH: /opt/nodejs/node_modules
        DATABASE_URL: !Ref DatabaseUrl
        COGNITO_USER_POOL_ID: !Ref CognitoUserPoolId
        COGNITO_CLIENT_ID: !Ref CognitoClientId
        AWS_ACCOUNT_ID: !Ref AWS::AccountId
        ENVIRONMENT: !Ref Environment
        PROJECT_NAME: !Ref ProjectName
        LICENSE_API_URL: https://mhutjgpipiklepvjrboi.supabase.co/functions/v1/validate-license
        LICENSE_CREATE_API_URL: https://mhutjgpipiklepvjrboi.supabase.co/functions/v1/api-create-trial
        LICENSE_API_KEY: nck_59707b56bf8def71dfb657bb8f2f4b9c
        TOKEN_ENCRYPTION_KEY: !Ref TokenEncryptionKey
        AZURE_OAUTH_CLIENT_ID: !Ref AzureOAuthClientId
        AZURE_OAUTH_CLIENT_SECRET: !Ref AzureOAuthClientSecret
        AZURE_OAUTH_REDIRECT_URI: !Ref AzureOAuthRedirectUri
        APP_DOMAIN: !Ref AppDomain
        API_DOMAIN: !Sub 'api-${AppDomain}'
        WEBAUTHN_RP_ID: !Ref WebAuthnRpId
        WEBAUTHN_ORIGIN: !Sub 'https://${AppDomain}'
        WEBAUTHN_RP_NAME: !Ref WebAuthnRpName
    Layers:
      - !Ref DependenciesLayer
Parameters:
  Environment:
    Type: String
    Default: production
    AllowedValues: [sandbox, production]
  
  ProjectName:
    Type: String
    Default: evo-uds-v3
  DatabaseUrl:
    Type: String
    NoEcho: true
    Description: PostgreSQL connection string
  CognitoUserPoolId:
    Type: String
    Description: Existing Cognito User Pool ID
  CognitoUserPoolArn:
    Type: String
    Description: Existing Cognito User Pool ARN
  CognitoClientId:
    Type: String
    Description: Cognito User Pool Client ID for JWT audience
  LambdaSecurityGroupId:
    Type: String
    Description: Security Group ID for Lambda functions
  PrivateSubnet1Id:
    Type: String
    Description: Private Subnet 1 ID
  PrivateSubnet2Id:
    Type: String
    Description: Private Subnet 2 ID
  TokenEncryptionKey:
    Type: String
    NoEcho: true
    Description: Base64-encoded 32-byte key for encrypting sensitive credentials (Azure client secrets, OAuth tokens)
    Default: ''
  AzureOAuthClientId:
    Type: String
    Description: Azure App Registration Client ID for OAuth flow
    Default: ''
  AzureOAuthClientSecret:
    Type: String
    NoEcho: true
    Description: Azure App Registration Client Secret for OAuth flow
    Default: ''
  AzureOAuthRedirectUri:
    Type: String
    Description: Azure OAuth redirect URI
    Default: 'https://evo.nuevacore.com/azure/callback'
  AppDomain:
    Type: String
    Description: Base application domain (e.g., evo.nuevacore.com)
    Default: 'evo.nuevacore.com'
  WebAuthnRpId:
    Type: String
    Description: WebAuthn Relying Party ID (registrable domain)
    Default: ''
  WebAuthnRpName:
    Type: String
    Description: WebAuthn Relying Party display name
    Default: 'EVO Platform'
Resources:
  # ==========================================================================
  # LAMBDA LAYER - Prisma + zod (AWS SDK bundled by esbuild)
  # ==========================================================================
  DependenciesLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: !Sub '${ProjectName}-${Environment}-deps'
      Description: Prisma Client + zod for EVO Platform
      ContentUri: ../backend/layers/dependencies/
      CompatibleRuntimes:
        - nodejs20.x
      CompatibleArchitectures:
        - arm64
      RetentionPolicy: Retain
  # ==========================================================================
  # IAM ROLE - Lambda Execution Role
  # ==========================================================================
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-${Environment}-lambda-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
        - arn:aws:iam::aws:policy/AmazonBedrockFullAccess
      Policies:
        - PolicyName: LambdaPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: '*'
              - Effect: Allow
                Action:
                  - cognito-idp:*
                Resource: !Ref CognitoUserPoolArn
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                  - s3:ListBucket
                Resource: '*'
              - Effect: Allow
                Action:
                  - ses:SendEmail
                  - ses:SendRawEmail
                Resource: '*'
              - Effect: Allow
                Action:
                  - sts:AssumeRole
                Resource: '*'
              - Effect: Allow
                Action:
                  - ce:*
                  - cloudwatch:*
                  - cloudtrail:*
                  - guardduty:*
                  - securityhub:*
                  - iam:*
                  - ec2:Describe*
                  - rds:Describe*
                  - s3:List*
                  - s3:GetBucket*
                  - lambda:List*
                  - lambda:Get*
                  - lambda:InvokeFunction
                  - lambda:UpdateFunctionConfiguration
                  - wafv2:*
                Resource: '*'
              - Effect: Allow
                Action:
                  - ssm:GetParameter
                  - ssm:GetParameters
                  - ssm:PutParameter
                  - ssm:DeleteParameter
                Resource: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/evo-uds-v3/*'
  # ==========================================================================
  # API GATEWAY - HTTP API with JWT Authorizer
  # ==========================================================================
  HttpApi:
    Type: AWS::Serverless::HttpApi
    Properties:
      StageName: prod
      CorsConfiguration:
        AllowMethods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
        AllowHeaders:
          - Content-Type
          - Authorization
          - X-Requested-With
          - X-API-Key
          - X-Request-ID
          - X-CSRF-Token
          - X-Correlation-ID
          - X-Amz-Date
          - X-Amz-Security-Token
          - X-Impersonate-Organization
        AllowOrigins:
          - '*'
        MaxAge: 600
      Auth:
        DefaultAuthorizer: CognitoAuthorizer
        Authorizers:
          CognitoAuthorizer:
            IdentitySource: $request.header.Authorization
            JwtConfiguration:
              issuer: !Sub 'https://cognito-idp.us-east-1.amazonaws.com/${CognitoUserPoolId}'
              audience:
                - !Ref CognitoClientId
  # ==========================================================================
  # ADMIN FUNCTIONS (16)
  # ==========================================================================
  AdminAzureCredentialsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-admin-azure-credentials'
      CodeUri: ../backend/src/handlers/admin/
      Handler: admin-azure-credentials.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 30
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/admin-azure-credentials
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - admin-azure-credentials.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  AdminEvoAppCredentialsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-admin-evo-app-credentials'
      CodeUri: ../backend/src/handlers/admin/
      Handler: admin-evo-app-credentials.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 120
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/admin-evo-app-credentials
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - admin-evo-app-credentials.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  AdminManageUserFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-admin-manage-user'
      CodeUri: ../backend/src/handlers/admin/
      Handler: admin-manage-user.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/admin-manage-user
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - admin-manage-user.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  AutomatedCleanupStuckScansFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-automated-cleanup-stuck-scans'
      CodeUri: ../backend/src/handlers/admin/
      Handler: automated-cleanup-stuck-scans.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
      Events:
        ScheduleCleanup:
          Type: Schedule
          Properties:
            Schedule: rate(30 minutes)
            Description: Cleanup stuck scans every 30 minutes
            Enabled: true
            Input: '{"detail-type":"Scheduled Event","source":"aws.events","detail":{"thresholdMinutes":60,"maxScansToCleanup":50}}'
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - automated-cleanup-stuck-scans.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  CleanupStuckScansFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-cleanup-stuck-scans'
      CodeUri: ../backend/src/handlers/admin/
      Handler: cleanup-stuck-scans.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - cleanup-stuck-scans.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  CreateCognitoUserFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-create-cognito-user'
      CodeUri: ../backend/src/handlers/admin/
      Handler: create-cognito-user.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/create-cognito-user
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - create-cognito-user.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  CreateUserFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-create-user'
      CodeUri: ../backend/src/handlers/admin/
      Handler: create-user.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/create-user
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - create-user.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  DeactivateDemoModeFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-deactivate-demo-mode'
      CodeUri: ../backend/src/handlers/admin/
      Handler: deactivate-demo-mode.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/deactivate-demo-mode
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - deactivate-demo-mode.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  DebugCloudtrailFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-debug-cloudtrail'
      CodeUri: ../backend/src/handlers/admin/
      Handler: debug-cloudtrail.handler
      Role: !GetAtt LambdaExecutionRole.Arn
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - debug-cloudtrail.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  DirectCleanupFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-direct-cleanup'
      CodeUri: ../backend/src/handlers/admin/
      Handler: direct-cleanup.handler
      Role: !GetAtt LambdaExecutionRole.Arn
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - direct-cleanup.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  DisableCognitoUserFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-disable-cognito-user'
      CodeUri: ../backend/src/handlers/admin/
      Handler: disable-cognito-user.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/disable-cognito-user
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - disable-cognito-user.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  LogAuditFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-log-audit'
      CodeUri: ../backend/src/handlers/admin/
      Handler: log-audit.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/log-audit
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - log-audit.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  ManageDemoModeFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-manage-demo-mode'
      CodeUri: ../backend/src/handlers/admin/
      Handler: manage-demo-mode.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/manage-demo-mode
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - manage-demo-mode.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  ManageEmailTemplatesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-manage-email-templates'
      CodeUri: ../backend/src/handlers/admin/
      Handler: manage-email-templates.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/manage-email-templates
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - manage-email-templates.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  ManageOrganizationsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-manage-organizations'
      CodeUri: ../backend/src/handlers/admin/
      Handler: manage-organizations.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/manage-organizations
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - manage-organizations.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  RunMigrationFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-run-migration'
      CodeUri: ../backend/src/handlers/admin/
      Handler: run-migration.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - run-migration.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  RunSqlFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-run-sql'
      CodeUri: ../backend/src/handlers/admin/
      Handler: run-sql.handler
      Role: !GetAtt LambdaExecutionRole.Arn
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - run-sql.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  SetupLicenseConfigFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-setup-license-config'
      CodeUri: ../backend/src/handlers/admin/
      Handler: setup-license-config.handler
      Role: !GetAtt LambdaExecutionRole.Arn
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - setup-license-config.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  # ==========================================================================
  # AI FUNCTIONS (8)
  # ==========================================================================
  BedrockChatFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-bedrock-chat'
      CodeUri: ../backend/src/handlers/ai/
      Handler: bedrock-chat.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/bedrock-chat
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - bedrock-chat.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  CheckProactiveNotificationsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-check-proactive-notifications'
      CodeUri: ../backend/src/handlers/ai/
      Handler: check-proactive-notifications.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 120
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - check-proactive-notifications.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  GenerateResponseFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-generate-response'
      CodeUri: ../backend/src/handlers/ai/
      Handler: generate-response.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 120
      MemorySize: 512
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - generate-response.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  GetAiNotificationsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-get-ai-notifications'
      CodeUri: ../backend/src/handlers/ai/
      Handler: get-ai-notifications.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/get-ai-notifications
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - get-ai-notifications.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  ListAiNotificationsAdminFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-list-ai-notifications-admin'
      CodeUri: ../backend/src/handlers/ai/
      Handler: list-ai-notifications-admin.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/list-ai-notifications-admin
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - list-ai-notifications-admin.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  ManageNotificationRulesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-manage-notification-rules'
      CodeUri: ../backend/src/handlers/ai/
      Handler: manage-notification-rules.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/manage-notification-rules
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - manage-notification-rules.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  SendAiNotificationFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-send-ai-notification'
      CodeUri: ../backend/src/handlers/ai/
      Handler: send-ai-notification.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/send-ai-notification
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - send-ai-notification.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  UpdateAiNotificationFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-update-ai-notification'
      CodeUri: ../backend/src/handlers/ai/
      Handler: update-ai-notification.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/update-ai-notification
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - update-ai-notification.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  # ==========================================================================
  # AUTH FUNCTIONS (13)
  # ==========================================================================
  DeleteWebauthnCredentialFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-delete-webauthn-credential'
      CodeUri: ../backend/src/handlers/auth/
      Handler: delete-webauthn-credential.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/delete-webauthn-credential
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - delete-webauthn-credential.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  ForgotPasswordFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-forgot-password'
      CodeUri: ../backend/src/handlers/auth/
      Handler: forgot-password.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/forgot-password
            Method: POST
            Auth:
              Authorizer: NONE
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - forgot-password.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  ChangePasswordFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-change-password'
      CodeUri: ../backend/src/handlers/auth/
      Handler: change-password.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/change-password
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - change-password.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  MfaEnrollFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-mfa-enroll'
      CodeUri: ../backend/src/handlers/auth/
      Handler: mfa-handlers.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/mfa-enroll
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - mfa-handlers.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  MfaCheckFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-mfa-check'
      CodeUri: ../backend/src/handlers/auth/
      Handler: mfa-handlers.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/mfa-check
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - mfa-handlers.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  MfaChallengeVerifyFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-mfa-challenge-verify'
      CodeUri: ../backend/src/handlers/auth/
      Handler: mfa-handlers.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/mfa-challenge-verify
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - mfa-handlers.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  MfaVerifyLoginFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-mfa-verify-login'
      CodeUri: ../backend/src/handlers/auth/
      Handler: mfa-handlers.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/mfa-verify-login
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - mfa-handlers.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  MfaListFactorsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-mfa-list-factors'
      CodeUri: ../backend/src/handlers/auth/
      Handler: mfa-handlers.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/mfa-list-factors
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - mfa-handlers.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  MfaUnenrollFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-mfa-unenroll'
      CodeUri: ../backend/src/handlers/auth/
      Handler: mfa-handlers.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/mfa-unenroll
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - mfa-handlers.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  SelfRegisterFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-self-register'
      CodeUri: ../backend/src/handlers/auth/
      Handler: self-register.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 60
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/self-register
            Method: POST
            Auth:
              Authorizer: NONE
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - self-register.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  VerifyTvTokenFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-verify-tv-token'
      CodeUri: ../backend/src/handlers/auth/
      Handler: verify-tv-token.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/verify-tv-token
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - verify-tv-token.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  WebauthnAuthenticateFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-webauthn-authenticate'
      CodeUri: ../backend/src/handlers/auth/
      Handler: webauthn-authenticate.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/webauthn-authenticate
            Method: POST
            Auth:
              Authorizer: NONE
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - webauthn-authenticate.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  WebauthnCheckFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-webauthn-check'
      CodeUri: ../backend/src/handlers/auth/
      Handler: webauthn-check-standalone.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/webauthn-check
            Method: POST
            Auth:
              Authorizer: NONE
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - webauthn-check-standalone.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  WebauthnRegisterFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-webauthn-register'
      CodeUri: ../backend/src/handlers/auth/
      Handler: webauthn-register.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/webauthn-register
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - webauthn-register.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  # ==========================================================================
  # AWS FUNCTIONS (3)
  # ==========================================================================
  ListAwsCredentialsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-list-aws-credentials'
      CodeUri: ../backend/src/handlers/aws/
      Handler: list-aws-credentials.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/list-aws-credentials
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - list-aws-credentials.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  SaveAwsCredentialsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-save-aws-credentials'
      CodeUri: ../backend/src/handlers/aws/
      Handler: save-aws-credentials.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/save-aws-credentials
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - save-aws-credentials.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  UpdateAwsCredentialsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-update-aws-credentials'
      CodeUri: ../backend/src/handlers/aws/
      Handler: update-aws-credentials.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/update-aws-credentials
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - update-aws-credentials.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  # ==========================================================================
  # AZURE FUNCTIONS (22)
  # ==========================================================================
  AzureActivityLogsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-azure-activity-logs'
      CodeUri: ../backend/src/handlers/azure/
      Handler: azure-activity-logs.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 60
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/azure-activity-logs
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - azure-activity-logs.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  AzureComplianceScanFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-azure-compliance-scan'
      CodeUri: ../backend/src/handlers/azure/
      Handler: azure-compliance-scan.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
      MemorySize: 1024
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/azure-compliance-scan
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - azure-compliance-scan.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  AzureCostOptimizationFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-azure-cost-optimization'
      CodeUri: ../backend/src/handlers/azure/
      Handler: azure-cost-optimization.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/azure-cost-optimization
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - azure-cost-optimization.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  AzureDefenderScanFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-azure-defender-scan'
      CodeUri: ../backend/src/handlers/azure/
      Handler: azure-defender-scan.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/azure-defender-scan
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - azure-defender-scan.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  AzureDetectAnomaliesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-azure-detect-anomalies'
      CodeUri: ../backend/src/handlers/azure/
      Handler: azure-detect-anomalies.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/azure-detect-anomalies
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - azure-detect-anomalies.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  AzureFetchCostsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-azure-fetch-costs'
      CodeUri: ../backend/src/handlers/azure/
      Handler: azure-fetch-costs.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/azure-fetch-costs
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - azure-fetch-costs.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  AzureFetchEdgeServicesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-azure-fetch-edge-services'
      CodeUri: ../backend/src/handlers/azure/
      Handler: azure-fetch-edge-services.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 60
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/azure-fetch-edge-services
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - azure-fetch-edge-services.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  AzureFetchMonitorMetricsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-azure-fetch-monitor-metrics'
      CodeUri: ../backend/src/handlers/azure/
      Handler: azure-fetch-monitor-metrics.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 60
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/azure-fetch-monitor-metrics
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - azure-fetch-monitor-metrics.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  AzureOauthCallbackFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-azure-oauth-callback'
      CodeUri: ../backend/src/handlers/azure/
      Handler: azure-oauth-callback.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 60
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/azure-oauth-callback
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - azure-oauth-callback.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  AzureOauthInitiateFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-azure-oauth-initiate'
      CodeUri: ../backend/src/handlers/azure/
      Handler: azure-oauth-initiate.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/azure-oauth-initiate
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - azure-oauth-initiate.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  AzureOauthRefreshFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-azure-oauth-refresh'
      CodeUri: ../backend/src/handlers/azure/
      Handler: azure-oauth-refresh.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/azure-oauth-refresh
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - azure-oauth-refresh.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  AzureOauthRevokeFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-azure-oauth-revoke'
      CodeUri: ../backend/src/handlers/azure/
      Handler: azure-oauth-revoke.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/azure-oauth-revoke
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - azure-oauth-revoke.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  AzureReservationsAnalyzerFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-azure-reservations-analyzer'
      CodeUri: ../backend/src/handlers/azure/
      Handler: azure-reservations-analyzer.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/azure-reservations-analyzer
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - azure-reservations-analyzer.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  AzureResourceInventoryFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-azure-resource-inventory'
      CodeUri: ../backend/src/handlers/azure/
      Handler: azure-resource-inventory.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/azure-resource-inventory
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - azure-resource-inventory.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  AzureSecurityScanFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-azure-security-scan'
      CodeUri: ../backend/src/handlers/azure/
      Handler: azure-security-scan.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
      MemorySize: 1024
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/azure-security-scan
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - azure-security-scan.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  AzureWellArchitectedScanFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-azure-well-architected-scan'
      CodeUri: ../backend/src/handlers/azure/
      Handler: azure-well-architected-scan.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
      MemorySize: 512
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/azure-well-architected-scan
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - azure-well-architected-scan.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  DeleteAzureCredentialsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-delete-azure-credentials'
      CodeUri: ../backend/src/handlers/azure/
      Handler: delete-azure-credentials.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/delete-azure-credentials
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - delete-azure-credentials.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  ListAzureCredentialsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-list-azure-credentials'
      CodeUri: ../backend/src/handlers/azure/
      Handler: list-azure-credentials.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/list-azure-credentials
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - list-azure-credentials.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  SaveAzureCredentialsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-save-azure-credentials'
      CodeUri: ../backend/src/handlers/azure/
      Handler: save-azure-credentials.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/save-azure-credentials
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - save-azure-credentials.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  StartAzureSecurityScanFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-start-azure-security-scan'
      CodeUri: ../backend/src/handlers/azure/
      Handler: start-azure-security-scan.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 60
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/start-azure-security-scan
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - start-azure-security-scan.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  ValidateAzureCredentialsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-validate-azure-credentials'
      CodeUri: ../backend/src/handlers/azure/
      Handler: validate-azure-credentials.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 60
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/validate-azure-credentials
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - validate-azure-credentials.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  ValidateAzurePermissionsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-validate-azure-permissions'
      CodeUri: ../backend/src/handlers/azure/
      Handler: validate-azure-permissions.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 60
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/validate-azure-permissions
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - validate-azure-permissions.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  # ==========================================================================
  # CLOUD FUNCTIONS (1)
  # ==========================================================================
  ListCloudCredentialsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-list-cloud-credentials'
      CodeUri: ../backend/src/handlers/cloud/
      Handler: list-cloud-credentials.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/list-cloud-credentials
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - list-cloud-credentials.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  # ==========================================================================
  # COST FUNCTIONS (12)
  # ==========================================================================
  AnalyzeRiSpFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-analyze-ri-sp'
      CodeUri: ../backend/src/handlers/cost/
      Handler: analyze-ri-sp.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
      MemorySize: 512
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/analyze-ri-sp
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - analyze-ri-sp.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  BudgetForecastFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-budget-forecast'
      CodeUri: ../backend/src/handlers/cost/
      Handler: budget-forecast.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/budget-forecast
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - budget-forecast.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  CostOptimizationFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-cost-optimization'
      CodeUri: ../backend/src/handlers/cost/
      Handler: cost-optimization.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
      MemorySize: 512
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/cost-optimization
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - cost-optimization.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  FetchDailyCostsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-fetch-daily-costs'
      CodeUri: ../backend/src/handlers/cost/
      Handler: fetch-daily-costs.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
      MemorySize: 512
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/fetch-daily-costs
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - fetch-daily-costs.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  FinopsCopilotFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-finops-copilot'
      CodeUri: ../backend/src/handlers/cost/
      Handler: finops-copilot-v2.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/finops-copilot
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - finops-copilot-v2.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  GenerateCostForecastFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-generate-cost-forecast'
      CodeUri: ../backend/src/handlers/cost/
      Handler: generate-cost-forecast.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/generate-cost-forecast
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - generate-cost-forecast.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  GetRiSpAnalysisFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-get-ri-sp-analysis'
      CodeUri: ../backend/src/handlers/cost/
      Handler: get-ri-sp-analysis.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/get-ri-sp-analysis
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - get-ri-sp-analysis.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  GetRiSpDataFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-get-ri-sp-data'
      CodeUri: ../backend/src/handlers/cost/
      Handler: get-ri-sp-data.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/get-ri-sp-data
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - get-ri-sp-data.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  ListRiSpHistoryFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-list-ri-sp-history'
      CodeUri: ../backend/src/handlers/cost/
      Handler: list-ri-sp-history.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/list-ri-sp-history
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - list-ri-sp-history.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  MlWasteDetectionFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-ml-waste-detection'
      CodeUri: ../backend/src/handlers/cost/
      Handler: ml-waste-detection.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/ml-waste-detection
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - ml-waste-detection.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  RiSpAnalyzerFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-ri-sp-analyzer'
      CodeUri: ../backend/src/handlers/cost/
      Handler: ri-sp-analyzer.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
      MemorySize: 512
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/ri-sp-analyzer
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - ri-sp-analyzer.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  SaveRiSpAnalysisFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-save-ri-sp-analysis'
      CodeUri: ../backend/src/handlers/cost/
      Handler: save-ri-sp-analysis.handler
      Role: !GetAtt LambdaExecutionRole.Arn
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - save-ri-sp-analysis.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  # ==========================================================================
  # DASHBOARD FUNCTIONS (3)
  # ==========================================================================
  GetExecutiveDashboardFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-get-executive-dashboard'
      CodeUri: ../backend/src/handlers/dashboard/
      Handler: get-executive-dashboard.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 60
      MemorySize: 512
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/get-executive-dashboard
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - get-executive-dashboard.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  GetExecutiveDashboardPublicFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-get-executive-dashboard-public'
      CodeUri: ../backend/src/handlers/dashboard/
      Handler: get-executive-dashboard-public.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 60
      MemorySize: 512
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/get-executive-dashboard-public
            Method: POST
            Auth:
              Authorizer: NONE
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - get-executive-dashboard-public.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  ManageTvTokensFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-manage-tv-tokens'
      CodeUri: ../backend/src/handlers/dashboard/
      Handler: manage-tv-tokens.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/manage-tv-tokens
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - manage-tv-tokens.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  # ==========================================================================
  # DATA FUNCTIONS (5)
  # ==========================================================================
  CleanupCostDataFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-cleanup-cost-data'
      CodeUri: ../backend/src/handlers/data/
      Handler: cleanup-cost-data.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - cleanup-cost-data.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  MutateTableFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-mutate-table'
      CodeUri: ../backend/src/handlers/data/
      Handler: mutate-table.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/mutate-table
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - mutate-table.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  QueryTableFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-query-table'
      CodeUri: ../backend/src/handlers/data/
      Handler: query-table.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/query-table
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - query-table.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  TicketAttachmentsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-ticket-attachments'
      CodeUri: ../backend/src/handlers/data/
      Handler: ticket-attachments.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 60
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/ticket-attachments
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - ticket-attachments.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  TicketManagementFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-ticket-management'
      CodeUri: ../backend/src/handlers/data/
      Handler: ticket-management.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/ticket-management
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - ticket-management.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  # ==========================================================================
  # DEBUG FUNCTIONS (1)
  # ==========================================================================
  DiagnoseCostDashboardFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-diagnose-cost-dashboard'
      CodeUri: ../backend/src/handlers/debug/
      Handler: diagnose-cost-dashboard.handler
      Role: !GetAtt LambdaExecutionRole.Arn
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - diagnose-cost-dashboard.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  # ==========================================================================
  # INTEGRATIONS FUNCTIONS (2)
  # ==========================================================================
  CloudformationWebhookFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-cloudformation-webhook'
      CodeUri: ../backend/src/handlers/integrations/
      Handler: cloudformation-webhook.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/cloudformation-webhook
            Method: POST
            Auth:
              Authorizer: NONE
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - cloudformation-webhook.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  CreateJiraTicketFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-create-jira-ticket'
      CodeUri: ../backend/src/handlers/integrations/
      Handler: create-jira-ticket.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 60
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/create-jira-ticket
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - create-jira-ticket.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  # ==========================================================================
  # JOBS FUNCTIONS (15)
  # ==========================================================================
  AutoCleanupStuckScansFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-auto-cleanup-stuck-scans'
      CodeUri: ../backend/src/handlers/jobs/
      Handler: auto-cleanup-stuck-scans.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - auto-cleanup-stuck-scans.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  CleanupExpiredExternalIdsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-cleanup-expired-external-ids'
      CodeUri: ../backend/src/handlers/jobs/
      Handler: cleanup-expired-external-ids.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 60
      Events:
        ScheduleCleanup:
          Type: Schedule
          Properties:
            Schedule: rate(1 day)
            Description: Cleanup expired external IDs daily
            Enabled: true
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - cleanup-expired-external-ids.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  CleanupExpiredOauthStatesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-cleanup-expired-oauth-states'
      CodeUri: ../backend/src/handlers/jobs/
      Handler: cleanup-expired-oauth-states.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 60
      Events:
        ScheduleCleanup:
          Type: Schedule
          Properties:
            Schedule: rate(1 hour)
            Description: Cleanup expired OAuth states hourly
            Enabled: true
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - cleanup-expired-oauth-states.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  CleanupStuckScansJobsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-cleanup-stuck-scans-jobs'
      CodeUri: ../backend/src/handlers/jobs/
      Handler: cleanup-stuck-scans.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - cleanup-stuck-scans.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  ExecuteScheduledJobFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-execute-scheduled-job'
      CodeUri: ../backend/src/handlers/jobs/
      Handler: execute-scheduled-job.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
      MemorySize: 512
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/execute-scheduled-job
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - execute-scheduled-job.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  InitialDataLoadFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-initial-data-load'
      CodeUri: ../backend/src/handlers/jobs/
      Handler: initial-data-load.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - initial-data-load.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  CancelBackgroundJobFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-cancel-background-job'
      CodeUri: ../backend/src/handlers/jobs/
      Handler: cancel-background-job.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/cancel-background-job
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - cancel-background-job.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  RetryBackgroundJobFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-retry-background-job'
      CodeUri: ../backend/src/handlers/jobs/
      Handler: retry-background-job.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/retry-background-job
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - retry-background-job.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  ListBackgroundJobsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-list-background-jobs'
      CodeUri: ../backend/src/handlers/jobs/
      Handler: list-background-jobs.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/list-background-jobs
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - list-background-jobs.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  ProcessBackgroundJobsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-process-background-jobs'
      CodeUri: ../backend/src/handlers/jobs/
      Handler: process-background-jobs.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
      MemorySize: 512
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/process-background-jobs
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - process-background-jobs.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  ProcessEventsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-process-events'
      CodeUri: ../backend/src/handlers/jobs/
      Handler: process-events.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - process-events.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  ScheduledScanExecutorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-scheduled-scan-executor'
      CodeUri: ../backend/src/handlers/jobs/
      Handler: scheduled-scan-executor.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
      MemorySize: 512
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/scheduled-scan-executor
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - scheduled-scan-executor.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  ScheduledViewRefreshFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-scheduled-view-refresh'
      CodeUri: ../backend/src/handlers/jobs/
      Handler: scheduled-view-refresh.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
      Events:
        ScheduleRefresh:
          Type: Schedule
          Properties:
            Schedule: rate(6 hours)
            Description: Refresh security posture views every 6 hours
            Enabled: true
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - scheduled-view-refresh.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  SendScheduledEmailsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-send-scheduled-emails'
      CodeUri: ../backend/src/handlers/jobs/
      Handler: send-scheduled-emails.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 120
      Events:
        ScheduleEmails:
          Type: Schedule
          Properties:
            Schedule: rate(1 hour)
            Description: Process and send scheduled emails hourly
            Enabled: true
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - send-scheduled-emails.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  SyncResourceInventoryFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-sync-resource-inventory'
      CodeUri: ../backend/src/handlers/jobs/
      Handler: sync-resource-inventory.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - sync-resource-inventory.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  # ==========================================================================
  # KB FUNCTIONS (7)
  # ==========================================================================
  IncrementArticleHelpfulFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-increment-article-helpful'
      CodeUri: ../backend/src/handlers/kb/
      Handler: increment-article-helpful.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/increment-article-helpful
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - increment-article-helpful.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  IncrementArticleViewsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-increment-article-views'
      CodeUri: ../backend/src/handlers/kb/
      Handler: increment-article-views.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/increment-article-views
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - increment-article-views.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  KbAiSuggestionsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-kb-ai-suggestions'
      CodeUri: ../backend/src/handlers/kb/
      Handler: kb-ai-suggestions.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 60
      MemorySize: 512
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/kb-ai-suggestions
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - kb-ai-suggestions.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  KbAnalyticsDashboardFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-kb-analytics-dashboard'
      CodeUri: ../backend/src/handlers/kb/
      Handler: kb-analytics-dashboard.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/kb-analytics-dashboard
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - kb-analytics-dashboard.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  KbArticleTrackingFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-kb-article-tracking'
      CodeUri: ../backend/src/handlers/kb/
      Handler: kb-article-tracking.handler
      Role: !GetAtt LambdaExecutionRole.Arn
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - kb-article-tracking.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  KbExportPdfFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-kb-export-pdf'
      CodeUri: ../backend/src/handlers/kb/
      Handler: kb-export-pdf.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 60
      MemorySize: 512
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/kb-export-pdf
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - kb-export-pdf.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  TrackArticleViewDetailedFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-track-article-view-detailed'
      CodeUri: ../backend/src/handlers/kb/
      Handler: track-article-view-detailed.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/track-article-view-detailed
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - track-article-view-detailed.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  # ==========================================================================
  # LICENSE FUNCTIONS (9)
  # ==========================================================================
  AdminSyncLicenseFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-admin-sync-license'
      CodeUri: ../backend/src/handlers/license/
      Handler: admin-sync-license.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 60
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/admin-sync-license
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - admin-sync-license.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  CleanupSeatsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-cleanup-seats'
      CodeUri: ../backend/src/handlers/license/
      Handler: cleanup-seats.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 60
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - cleanup-seats.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  ConfigureLicenseFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-configure-license'
      CodeUri: ../backend/src/handlers/license/
      Handler: configure-license.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/configure-license
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - configure-license.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  DailyLicenseValidationFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-daily-license-validation'
      CodeUri: ../backend/src/handlers/license/
      Handler: daily-license-validation.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 120
      Events:
        DailyValidation:
          Type: Schedule
          Properties:
            Schedule: rate(1 day)
            Description: Daily license validation and expiration check
            Enabled: true
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - daily-license-validation.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  ManageSeatAssignmentsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-manage-seat-assignments'
      CodeUri: ../backend/src/handlers/license/
      Handler: manage-seat-assignments.handler
      Role: !GetAtt LambdaExecutionRole.Arn
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - manage-seat-assignments.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  ManageSeatsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-manage-seats'
      CodeUri: ../backend/src/handlers/license/
      Handler: manage-seats.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/manage-seats
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - manage-seats.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  ScheduledLicenseSyncFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-scheduled-license-sync'
      CodeUri: ../backend/src/handlers/license/
      Handler: scheduled-license-sync.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 120
      Events:
        ScheduleLicenseSync:
          Type: Schedule
          Properties:
            Schedule: rate(12 hours)
            Description: Sync license status every 12 hours
            Enabled: true
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - scheduled-license-sync.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  RetryFallbackLicensesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-retry-fallback-licenses'
      CodeUri: ../backend/src/handlers/jobs/
      Handler: retry-fallback-licenses.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 120
      Events:
        ScheduleRetry:
          Type: Schedule
          Properties:
            Schedule: rate(1 day)
            Description: Retry fallback licenses daily
            Enabled: true
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - retry-fallback-licenses.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  SyncLicenseFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-sync-license'
      CodeUri: ../backend/src/handlers/license/
      Handler: sync-license.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 60
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/sync-license
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - sync-license.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  ValidateLicenseFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-validate-license'
      CodeUri: ../backend/src/handlers/license/
      Handler: validate-license.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/validate-license
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - validate-license.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  # ==========================================================================
  # MAINTENANCE FUNCTIONS (2)
  # ==========================================================================
  MaintenanceAutoCleanupStuckScansFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-maintenance-auto-cleanup-stuck-scans'
      CodeUri: ../backend/src/handlers/maintenance/
      Handler: auto-cleanup-stuck-scans.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - auto-cleanup-stuck-scans.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  CleanupStuckScansSimpleFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-cleanup-stuck-scans-simple'
      CodeUri: ../backend/src/handlers/maintenance/
      Handler: cleanup-stuck-scans-simple.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - cleanup-stuck-scans-simple.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  # ==========================================================================
  # ML FUNCTIONS (5)
  # ==========================================================================
  AiPrioritizationFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-ai-prioritization'
      CodeUri: ../backend/src/handlers/ml/
      Handler: ai-prioritization.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 120
      MemorySize: 512
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - ai-prioritization.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  DetectAnomaliesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-detect-anomalies'
      CodeUri: ../backend/src/handlers/ml/
      Handler: detect-anomalies.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/detect-anomalies
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - detect-anomalies.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  GenerateAiInsightsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-generate-ai-insights'
      CodeUri: ../backend/src/handlers/ml/
      Handler: generate-ai-insights.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 120
      MemorySize: 512
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - generate-ai-insights.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  IntelligentAlertsAnalyzerFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-intelligent-alerts-analyzer'
      CodeUri: ../backend/src/handlers/ml/
      Handler: intelligent-alerts-analyzer.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/intelligent-alerts-analyzer
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - intelligent-alerts-analyzer.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  PredictIncidentsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-predict-incidents'
      CodeUri: ../backend/src/handlers/ml/
      Handler: predict-incidents.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/predict-incidents
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - predict-incidents.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  # ==========================================================================
  # MONITORING FUNCTIONS (17)
  # ==========================================================================
  AlertsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-alerts'
      CodeUri: ../backend/src/handlers/monitoring/
      Handler: alerts.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/alerts
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - alerts.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  AutoAlertsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-auto-alerts'
      CodeUri: ../backend/src/handlers/monitoring/
      Handler: auto-alerts.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/auto-alerts
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - auto-alerts.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  AwsRealtimeMetricsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-aws-realtime-metrics'
      CodeUri: ../backend/src/handlers/monitoring/
      Handler: aws-realtime-metrics.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 60
      MemorySize: 512
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/aws-realtime-metrics
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - aws-realtime-metrics.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  CheckAlertRulesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-check-alert-rules'
      CodeUri: ../backend/src/handlers/monitoring/
      Handler: check-alert-rules.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/check-alert-rules
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - check-alert-rules.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  EndpointMonitorCheckFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-endpoint-monitor-check'
      CodeUri: ../backend/src/handlers/monitoring/
      Handler: endpoint-monitor-check.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/endpoint-monitor-check
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - endpoint-monitor-check.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  ErrorAggregatorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-error-aggregator'
      CodeUri: ../backend/src/handlers/monitoring/
      Handler: error-aggregator.handler
      Role: !GetAtt LambdaExecutionRole.Arn
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - error-aggregator.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  FetchCloudwatchMetricsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-fetch-cloudwatch-metrics'
      CodeUri: ../backend/src/handlers/monitoring/
      Handler: fetch-cloudwatch-metrics.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 60
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/fetch-cloudwatch-metrics
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - fetch-cloudwatch-metrics.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  FetchEdgeServicesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-fetch-edge-services'
      CodeUri: ../backend/src/handlers/monitoring/
      Handler: fetch-edge-services.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 60
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/fetch-edge-services
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - fetch-edge-services.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  GenerateErrorFixPromptFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-generate-error-fix-prompt'
      CodeUri: ../backend/src/handlers/monitoring/
      Handler: generate-error-fix-prompt.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/generate-error-fix-prompt
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - generate-error-fix-prompt.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  GetLambdaHealthFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-get-lambda-health'
      CodeUri: ../backend/src/handlers/monitoring/
      Handler: get-lambda-health.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/get-lambda-health
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - get-lambda-health.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  GetPlatformMetricsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-get-platform-metrics'
      CodeUri: ../backend/src/handlers/monitoring/
      Handler: get-platform-metrics.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 60
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/get-platform-metrics
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - get-platform-metrics.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  GetRecentErrorsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-get-recent-errors'
      CodeUri: ../backend/src/handlers/monitoring/
      Handler: get-recent-errors.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/get-recent-errors
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - get-recent-errors.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  HealthCheckFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-health-check'
      CodeUri: ../backend/src/handlers/monitoring/
      Handler: health-check.handler
      Role: !GetAtt LambdaExecutionRole.Arn
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - health-check.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  LambdaHealthCheckFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-lambda-health-check'
      CodeUri: ../backend/src/handlers/monitoring/
      Handler: lambda-health-check.handler
      Role: !GetAtt LambdaExecutionRole.Arn
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - lambda-health-check.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  LogFrontendErrorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-log-frontend-error'
      CodeUri: ../backend/src/handlers/monitoring/
      Handler: log-frontend-error.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/log-frontend-error
            Method: POST
            Auth:
              Authorizer: NONE
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - log-frontend-error.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  MonitoredEndpointsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-monitored-endpoints'
      CodeUri: ../backend/src/handlers/monitoring/
      Handler: monitored-endpoints.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/monitored-endpoints
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - monitored-endpoints.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  TestLambdaMetricsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-test-lambda-metrics'
      CodeUri: ../backend/src/handlers/monitoring/
      Handler: test-lambda-metrics.handler
      Role: !GetAtt LambdaExecutionRole.Arn
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - test-lambda-metrics.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  # ==========================================================================
  # NOTIFICATIONS FUNCTIONS (4)
  # ==========================================================================
  GetCommunicationLogsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-get-communication-logs'
      CodeUri: ../backend/src/handlers/notifications/
      Handler: get-communication-logs.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/get-communication-logs
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - get-communication-logs.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  ManageEmailPreferencesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-manage-email-preferences'
      CodeUri: ../backend/src/handlers/notifications/
      Handler: manage-email-preferences.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/manage-email-preferences
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - manage-email-preferences.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  SendEmailFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-send-email'
      CodeUri: ../backend/src/handlers/notifications/
      Handler: send-email.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/send-email
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - send-email.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  SendNotificationFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-send-notification'
      CodeUri: ../backend/src/handlers/notifications/
      Handler: send-notification.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/send-notification
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - send-notification.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  # ==========================================================================
  # ORGANIZATIONS FUNCTIONS (2)
  # ==========================================================================
  CreateOrganizationAccountFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-create-organization-account'
      CodeUri: ../backend/src/handlers/organizations/
      Handler: create-organization-account.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/create-organization-account
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - create-organization-account.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  SyncOrganizationAccountsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-sync-organization-accounts'
      CodeUri: ../backend/src/handlers/organizations/
      Handler: sync-organization-accounts.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 60
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/sync-organization-accounts
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - sync-organization-accounts.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  # ==========================================================================
  # PROFILES FUNCTIONS (3)
  # ==========================================================================
  CheckOrganizationFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-check-organization'
      CodeUri: ../backend/src/handlers/profiles/
      Handler: check-organization.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/check-organization
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - check-organization.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  CreateWithOrganizationFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-create-with-organization'
      CodeUri: ../backend/src/handlers/profiles/
      Handler: create-with-organization.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/create-with-organization
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - create-with-organization.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  GetUserOrganizationFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-get-user-organization'
      CodeUri: ../backend/src/handlers/profiles/
      Handler: get-user-organization.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/get-user-organization
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - get-user-organization.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  # ==========================================================================
  # REPORTS FUNCTIONS (5)
  # ==========================================================================
  GenerateExcelReportFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-generate-excel-report'
      CodeUri: ../backend/src/handlers/reports/
      Handler: generate-excel-report.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/generate-excel-report
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - generate-excel-report.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  GeneratePdfReportFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-generate-pdf-report'
      CodeUri: ../backend/src/handlers/reports/
      Handler: generate-pdf-report.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/generate-pdf-report
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - generate-pdf-report.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  GenerateRemediationScriptFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-generate-remediation-script'
      CodeUri: ../backend/src/handlers/reports/
      Handler: generate-remediation-script.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 60
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/generate-remediation-script
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - generate-remediation-script.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  GenerateSecurityPdfFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-generate-security-pdf'
      CodeUri: ../backend/src/handlers/reports/
      Handler: generate-security-pdf.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/generate-security-pdf
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - generate-security-pdf.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  SecurityScanPdfExportFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-security-scan-pdf-export'
      CodeUri: ../backend/src/handlers/reports/
      Handler: security-scan-pdf-export.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/security-scan-pdf-export
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - security-scan-pdf-export.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  # ==========================================================================
  # SECURITY FUNCTIONS (28)
  # ==========================================================================
  AnalyzeCloudtrailFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-analyze-cloudtrail'
      CodeUri: ../backend/src/handlers/security/
      Handler: analyze-cloudtrail.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
      MemorySize: 512
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/analyze-cloudtrail
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - analyze-cloudtrail.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  ComplianceScanFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-compliance-scan'
      CodeUri: ../backend/src/handlers/security/
      Handler: compliance-scan.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
      MemorySize: 1024
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/compliance-scan
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - compliance-scan.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  CreateRemediationTicketFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-create-remediation-ticket'
      CodeUri: ../backend/src/handlers/security/
      Handler: create-remediation-ticket.handler
      Role: !GetAtt LambdaExecutionRole.Arn
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - create-remediation-ticket.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  DriftDetectionFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-drift-detection'
      CodeUri: ../backend/src/handlers/security/
      Handler: drift-detection.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/drift-detection
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - drift-detection.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  FetchCloudtrailFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-fetch-cloudtrail'
      CodeUri: ../backend/src/handlers/security/
      Handler: fetch-cloudtrail.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 60
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/fetch-cloudtrail
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - fetch-cloudtrail.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  GetComplianceHistoryFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-get-compliance-history'
      CodeUri: ../backend/src/handlers/security/
      Handler: get-compliance-history.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/get-compliance-history
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - get-compliance-history.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  GetComplianceScanStatusFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-get-compliance-scan-status'
      CodeUri: ../backend/src/handlers/security/
      Handler: get-compliance-scan-status.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/get-compliance-scan-status
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - get-compliance-scan-status.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  GetFindingsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-get-findings'
      CodeUri: ../backend/src/handlers/security/
      Handler: get-findings.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/get-findings
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - get-findings.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  GetSecurityPostureFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-get-security-posture'
      CodeUri: ../backend/src/handlers/security/
      Handler: get-security-posture.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/get-security-posture
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - get-security-posture.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  GuarddutyScanFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-guardduty-scan'
      CodeUri: ../backend/src/handlers/security/
      Handler: guardduty-scan.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/guardduty-scan
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - guardduty-scan.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  IamBehaviorAnalysisFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-iam-behavior-analysis'
      CodeUri: ../backend/src/handlers/security/
      Handler: iam-behavior-analysis.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 120
      MemorySize: 512
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - iam-behavior-analysis.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  IamDeepAnalysisFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-iam-deep-analysis'
      CodeUri: ../backend/src/handlers/security/
      Handler: iam-deep-analysis.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/iam-deep-analysis
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - iam-deep-analysis.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  LateralMovementDetectionFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-lateral-movement-detection'
      CodeUri: ../backend/src/handlers/security/
      Handler: lateral-movement-detection.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/lateral-movement-detection
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - lateral-movement-detection.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  SecurityScanFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-security-scan'
      CodeUri: ../backend/src/handlers/security/
      Handler: security-scan.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
      MemorySize: 1024
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/security-scan
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - security-scan.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  StartAnalyzeCloudtrailFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-start-analyze-cloudtrail'
      CodeUri: ../backend/src/handlers/security/
      Handler: start-analyze-cloudtrail.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 60
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - start-analyze-cloudtrail.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  StartCloudtrailAnalysisFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-start-cloudtrail-analysis'
      CodeUri: ../backend/src/handlers/security/
      Handler: start-cloudtrail-analysis.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 60
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/start-cloudtrail-analysis
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - start-cloudtrail-analysis.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  StartComplianceScanFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-start-compliance-scan'
      CodeUri: ../backend/src/handlers/security/
      Handler: start-compliance-scan.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 60
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/start-compliance-scan
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - start-compliance-scan.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  StartSecurityScanFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-start-security-scan'
      CodeUri: ../backend/src/handlers/security/
      Handler: start-security-scan.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 60
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/start-security-scan
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - start-security-scan.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  ValidateAwsCredentialsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-validate-aws-credentials'
      CodeUri: ../backend/src/handlers/security/
      Handler: validate-aws-credentials.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 60
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/validate-aws-credentials
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - validate-aws-credentials.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  ValidatePermissionsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-validate-permissions'
      CodeUri: ../backend/src/handlers/security/
      Handler: validate-permissions.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 60
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/validate-permissions
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - validate-permissions.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  ValidateWafSecurityFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-validate-waf-security'
      CodeUri: ../backend/src/handlers/security/
      Handler: validate-waf-security.handler
      Role: !GetAtt LambdaExecutionRole.Arn
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - validate-waf-security.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  WafDashboardApiFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-waf-dashboard-api'
      Description: 'WAF Dashboard API - bundled with AWS SDK v2'
      CodeUri: ../backend/src/handlers/security/
      Handler: waf-dashboard-api.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 60
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/waf-dashboard-api
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - waf-dashboard-api.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  WafLogForwarderFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-waf-log-forwarder'
      CodeUri: ../backend/src/handlers/security/
      Handler: waf-log-forwarder.handler
      Role: !GetAtt LambdaExecutionRole.Arn
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - waf-log-forwarder.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  WafLogProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-waf-log-processor'
      CodeUri: ../backend/src/handlers/security/
      Handler: waf-log-processor.handler
      Role: !GetAtt LambdaExecutionRole.Arn
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - waf-log-processor.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  WafSetupMonitoringFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-waf-setup-monitoring'
      CodeUri: ../backend/src/handlers/security/
      Handler: waf-setup-monitoring.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 60
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/waf-setup-monitoring
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - waf-setup-monitoring.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  WafThreatAnalyzerFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-waf-threat-analyzer'
      CodeUri: ../backend/src/handlers/security/
      Handler: waf-threat-analyzer.handler
      Role: !GetAtt LambdaExecutionRole.Arn
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - waf-threat-analyzer.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  WafUnblockExpiredFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-waf-unblock-expired'
      CodeUri: ../backend/src/handlers/security/
      Handler: waf-unblock-expired.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 60
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - waf-unblock-expired.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  WellArchitectedScanFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-well-architected-scan'
      CodeUri: ../backend/src/handlers/security/
      Handler: well-architected-scan.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
      MemorySize: 512
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/well-architected-scan
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - well-architected-scan.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  # ==========================================================================
  # STORAGE FUNCTIONS (3)
  # ==========================================================================
  StorageDownloadFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-storage-download'
      CodeUri: ../backend/src/handlers/storage/
      Handler: storage-handlers.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 60
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/storage-download
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - storage-handlers.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  StorageDeleteFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-storage-delete'
      CodeUri: ../backend/src/handlers/storage/
      Handler: storage-handlers.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/storage-delete
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - storage-handlers.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  UploadAttachmentFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-upload-attachment'
      CodeUri: ../backend/src/handlers/storage/
      Handler: storage-handlers.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 60
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/upload-attachment
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - storage-handlers.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  # ==========================================================================
  # SYSTEM FUNCTIONS (5)
  # ==========================================================================
  CheckMigrationsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-check-migrations'
      CodeUri: ../backend/src/handlers/system/
      Handler: check-migrations.handler
      Role: !GetAtt LambdaExecutionRole.Arn
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - check-migrations.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  DbInitFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-db-init'
      CodeUri: ../backend/src/handlers/system/
      Handler: db-init.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
      MemorySize: 512
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/db-init
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - db-init.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  ListTablesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-list-tables'
      CodeUri: ../backend/src/handlers/system/
      Handler: list-tables.handler
      Role: !GetAtt LambdaExecutionRole.Arn
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - list-tables.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  RunMigrationsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-run-migrations'
      CodeUri: ../backend/src/handlers/system/
      Handler: run-migrations.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - run-migrations.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  RunSqlMigrationFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-run-sql-migration'
      CodeUri: ../backend/src/handlers/system/
      Handler: run-sql-migration.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - run-sql-migration.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  # ==========================================================================
  # USER FUNCTIONS (1)
  # ==========================================================================
  NotificationSettingsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-notification-settings'
      CodeUri: ../backend/src/handlers/user/
      Handler: notification-settings.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/notification-settings
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - notification-settings.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  # ==========================================================================
  # WEBSOCKET FUNCTIONS (2)
  # ==========================================================================
  WebsocketConnectFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-websocket-connect'
      CodeUri: ../backend/src/handlers/websocket/
      Handler: connect.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/websocket-connect
            Method: POST
            Auth:
              Authorizer: NONE
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - connect.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
  WebsocketDisconnectFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-websocket-disconnect'
      CodeUri: ../backend/src/handlers/websocket/
      Handler: disconnect.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /api/functions/websocket-disconnect
            Method: POST
            Auth:
              Authorizer: NONE
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - disconnect.ts
        External:
          - '@prisma/client'
          - '.prisma/client'
Outputs:
  HttpApiUrl:
    Description: HTTP API URL
    Value: !Sub 'https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com/prod'
  
  HttpApiId:
    Description: HTTP API ID for custom domain mapping
    Value: !Ref HttpApi
  
  LambdaCount:
    Description: Total Lambda functions deployed
    Value: '194'
