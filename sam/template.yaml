AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: |
  EVO Platform - Serverless Application
  203 Lambda Functions + API Gateway + Infrastructure
  Generated by scripts/generate-sam-template.ts

Globals:
  Function:
    Runtime: nodejs18.x
    Timeout: 30
    MemorySize: 256
    Architectures:
      - x86_64
    VpcConfig:
      SecurityGroupIds:
        - !Ref LambdaSecurityGroup
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
    Environment:
      Variables:
        NODE_PATH: /opt/nodejs/node_modules
        DATABASE_URL: !Sub '{{resolve:secretsmanager:${DatabaseSecret}:SecretString:DATABASE_URL}}'
        COGNITO_USER_POOL_ID: !Ref UserPool
        AWS_ACCOUNT_ID: !Ref AWS::AccountId
    Layers:
      - !Ref DependenciesLayer

Parameters:
  Environment:
    Type: String
    Default: sandbox
    AllowedValues: [sandbox, production]
  
  ProjectName:
    Type: String
    Default: evo-uds-v3

  DatabasePassword:
    Type: String
    NoEcho: true
    MinLength: 16

Resources:
  # ==========================================================================
  # NETWORKING
  # ==========================================================================
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-vpc'

  InternetGateway:
    Type: AWS::EC2::InternetGateway

  InternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: 10.0.1.0/24
      MapPublicIpOnLaunch: true

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [1, !GetAZs '']
      CidrBlock: 10.0.2.0/24
      MapPublicIpOnLaunch: true

  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: 10.0.10.0/24

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [1, !GetAZs '']
      CidrBlock: 10.0.11.0/24

  NatGatewayEIP:
    Type: AWS::EC2::EIP
    DependsOn: InternetGatewayAttachment
    Properties:
      Domain: vpc

  NatGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatGatewayEIP.AllocationId
      SubnetId: !Ref PublicSubnet1

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: InternetGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC

  PrivateRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway

  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1
      RouteTableId: !Ref PrivateRouteTable

  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable

  # ==========================================================================
  # SECURITY GROUPS
  # ==========================================================================
  LambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Lambda functions
      VpcId: !Ref VPC
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0

  DatabaseSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for RDS
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref LambdaSecurityGroup

  # ==========================================================================
  # DATABASE
  # ==========================================================================
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnet group for RDS
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2

  Database:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Snapshot
    Properties:
      DBInstanceIdentifier: !Sub '${ProjectName}-${Environment}-postgres'
      DBInstanceClass: db.t3.micro
      Engine: postgres
      EngineVersion: '15'
      AllocatedStorage: 20
      StorageType: gp3
      DBName: evouds
      MasterUsername: evoadmin
      MasterUserPassword: !Ref DatabasePassword
      VPCSecurityGroups:
        - !Ref DatabaseSecurityGroup
      DBSubnetGroupName: !Ref DBSubnetGroup
      PubliclyAccessible: false
      BackupRetentionPeriod: 7

  DatabaseSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub '${ProjectName}/${Environment}/database'
      SecretString: !Sub |
        {
          "DATABASE_URL": "postgresql://evoadmin:${DatabasePassword}@${Database.Endpoint.Address}:5432/evouds?schema=public"
        }

  # ==========================================================================
  # COGNITO
  # ==========================================================================
  UserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: !Sub '${ProjectName}-${Environment}-users'
      AutoVerifiedAttributes: [email]
      UsernameAttributes: [email]
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireLowercase: true
          RequireNumbers: true
          RequireUppercase: true

  UserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: !Sub '${ProjectName}-${Environment}-web'
      UserPoolId: !Ref UserPool
      GenerateSecret: false
      ExplicitAuthFlows:
        - ALLOW_USER_PASSWORD_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH
        - ALLOW_USER_SRP_AUTH

  # ==========================================================================
  # FRONTEND (S3 + CloudFront)
  # ==========================================================================
  FrontendBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-${Environment}-frontend-${AWS::AccountId}'
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      WebsiteConfiguration:
        IndexDocument: index.html
        ErrorDocument: index.html

  FrontendBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref FrontendBucket
      PolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: cloudfront.amazonaws.com
            Action: s3:GetObject
            Resource: !Sub '${FrontendBucket.Arn}/*'
            Condition:
              StringEquals:
                AWS:SourceArn: !Sub 'arn:aws:cloudfront::${AWS::AccountId}:distribution/${CloudFrontDistribution}'

  CloudFrontOriginAccessControl:
    Type: AWS::CloudFront::OriginAccessControl
    Properties:
      OriginAccessControlConfig:
        Name: !Sub '${ProjectName}-${Environment}-oac'
        OriginAccessControlOriginType: s3
        SigningBehavior: always
        SigningProtocol: sigv4

  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        DefaultRootObject: index.html
        Origins:
          - Id: S3Origin
            DomainName: !GetAtt FrontendBucket.RegionalDomainName
            OriginAccessControlId: !Ref CloudFrontOriginAccessControl
            S3OriginConfig:
              OriginAccessIdentity: ''
        DefaultCacheBehavior:
          TargetOriginId: S3Origin
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods: [GET, HEAD, OPTIONS]
          CachedMethods: [GET, HEAD]
          ForwardedValues:
            QueryString: false
            Cookies:
              Forward: none
          Compress: true
        CustomErrorResponses:
          - ErrorCode: 403
            ResponseCode: 200
            ResponsePagePath: /index.html
          - ErrorCode: 404
            ResponseCode: 200
            ResponsePagePath: /index.html
        PriceClass: PriceClass_100

  # ==========================================================================
  # LAMBDA LAYER
  # ==========================================================================
  DependenciesLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: !Sub '${ProjectName}-${Environment}-deps'
      ContentUri: ../backend/layers/dependencies/
      CompatibleRuntimes:
        - nodejs18.x
      RetentionPolicy: Retain
    Metadata:
      BuildMethod: nodejs18.x

  # ==========================================================================
  # API GATEWAY
  # ==========================================================================
  Api:
    Type: AWS::Serverless::Api
    Properties:
      Name: !Sub '${ProjectName}-${Environment}-api'
      StageName: prod
      Auth:
        DefaultAuthorizer: CognitoAuthorizer
        Authorizers:
          CognitoAuthorizer:
            UserPoolArn: !GetAtt UserPool.Arn
      Cors:
        AllowMethods: "'GET,POST,PUT,DELETE,OPTIONS'"
        AllowHeaders: "'Content-Type,Authorization,X-Requested-With,X-API-Key,X-Request-ID,X-CSRF-Token,X-Correlation-ID,X-Amz-Date,X-Amz-Security-Token,X-Impersonate-Organization'"
        AllowOrigin: "'*'"

  # ==========================================================================
  # LAMBDA FUNCTIONS
  # ==========================================================================
  AdminManageUserFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-admin-manage-user'
      CodeUri: ../backend/
      Handler: dist/handlers/admin/admin-manage-user.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/admin-manage-user
            Method: POST

  AutomatedCleanupStuckScansFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-automated-cleanup-stuck-scans'
      CodeUri: ../backend/
      Handler: dist/handlers/admin/automated-cleanup-stuck-scans.handler
      Timeout: 300

  CheckCloudtrailStatusFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-check-cloudtrail-status'
      CodeUri: ../backend/
      Handler: dist/handlers/admin/check-cloudtrail-status.handler

  CheckCostsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-check-costs'
      CodeUri: ../backend/
      Handler: dist/handlers/admin/check-costs.handler

  CleanupStuckScansFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-cleanup-stuck-scans'
      CodeUri: ../backend/
      Handler: dist/handlers/admin/cleanup-stuck-scans.handler
      Timeout: 300

  CreateCognitoUserFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-create-cognito-user'
      CodeUri: ../backend/
      Handler: dist/handlers/admin/create-cognito-user.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/create-cognito-user
            Method: POST

  CreateUserFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-create-user'
      CodeUri: ../backend/
      Handler: dist/handlers/admin/create-user.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/create-user
            Method: POST

  DeactivateDemoModeFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-deactivate-demo-mode'
      CodeUri: ../backend/
      Handler: dist/handlers/admin/deactivate-demo-mode.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/deactivate-demo-mode
            Method: POST

  DebugCloudtrailFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-debug-cloudtrail'
      CodeUri: ../backend/
      Handler: dist/handlers/admin/debug-cloudtrail.handler

  DirectCleanupFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-direct-cleanup'
      CodeUri: ../backend/
      Handler: dist/handlers/admin/direct-cleanup.handler

  DisableCognitoUserFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-disable-cognito-user'
      CodeUri: ../backend/
      Handler: dist/handlers/admin/disable-cognito-user.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/disable-cognito-user
            Method: POST

  FixRoleArnMigrationFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-fix-role-arn-migration'
      CodeUri: ../backend/
      Handler: dist/handlers/admin/fix-role-arn-migration.handler

  LogAuditFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-log-audit'
      CodeUri: ../backend/
      Handler: dist/handlers/admin/log-audit.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/log-audit
            Method: POST

  ManageDemoModeFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-manage-demo-mode'
      CodeUri: ../backend/
      Handler: dist/handlers/admin/manage-demo-mode.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/manage-demo-mode
            Method: POST

  ManageEmailTemplatesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-manage-email-templates'
      CodeUri: ../backend/
      Handler: dist/handlers/admin/manage-email-templates.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/manage-email-templates
            Method: POST

  ManageOrganizationsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-manage-organizations'
      CodeUri: ../backend/
      Handler: dist/handlers/admin/manage-organizations.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/manage-organizations
            Method: POST

  RunMigrationFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-run-migration'
      CodeUri: ../backend/
      Handler: dist/handlers/admin/run-migration.handler
      Timeout: 300

  RunMigrationStandaloneFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-run-migration-standalone'
      CodeUri: ../backend/
      Handler: dist/handlers/admin/run-migration-standalone.handler
      Timeout: 300

  RunSqlFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-run-sql'
      CodeUri: ../backend/
      Handler: dist/handlers/admin/run-sql.handler

  SetupLicenseConfigFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-setup-license-config'
      CodeUri: ../backend/
      Handler: dist/handlers/admin/setup-license-config.handler

  BedrockChatFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-bedrock-chat'
      CodeUri: ../backend/
      Handler: dist/handlers/ai/bedrock-chat.handler
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/bedrock-chat
            Method: POST

  CheckProactiveNotificationsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-check-proactive-notifications'
      CodeUri: ../backend/
      Handler: dist/handlers/ai/check-proactive-notifications.handler
      Timeout: 120

  GenerateResponseFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-generate-response'
      CodeUri: ../backend/
      Handler: dist/handlers/ai/generate-response.handler
      Timeout: 120
      MemorySize: 512

  GetAiNotificationsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-get-ai-notifications'
      CodeUri: ../backend/
      Handler: dist/handlers/ai/get-ai-notifications.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/get-ai-notifications
            Method: POST

  ListAiNotificationsAdminFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-list-ai-notifications-admin'
      CodeUri: ../backend/
      Handler: dist/handlers/ai/list-ai-notifications-admin.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/list-ai-notifications-admin
            Method: POST

  ManageNotificationRulesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-manage-notification-rules'
      CodeUri: ../backend/
      Handler: dist/handlers/ai/manage-notification-rules.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/manage-notification-rules
            Method: POST

  SendAiNotificationFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-send-ai-notification'
      CodeUri: ../backend/
      Handler: dist/handlers/ai/send-ai-notification.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/send-ai-notification
            Method: POST

  UpdateAiNotificationFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-update-ai-notification'
      CodeUri: ../backend/
      Handler: dist/handlers/ai/update-ai-notification.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/update-ai-notification
            Method: POST

  DeleteWebauthnCredentialFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-delete-webauthn-credential'
      CodeUri: ../backend/
      Handler: dist/handlers/auth/delete-webauthn-credential.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/delete-webauthn-credential
            Method: POST

  DeleteWebauthnCredentialAdminFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-delete-webauthn-credential-admin'
      CodeUri: ../backend/
      Handler: dist/handlers/auth/delete-webauthn-credential-admin.handler

  ForgotPasswordFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-forgot-password'
      CodeUri: ../backend/
      Handler: dist/handlers/auth/forgot-password.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/forgot-password
            Method: POST
            Auth:
              Authorizer: NONE

  MfaEnrollFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-mfa-enroll'
      CodeUri: ../backend/
      Handler: dist/handlers/auth/mfa-handlers.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/mfa-enroll
            Method: POST

  MfaCheckFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-mfa-check'
      CodeUri: ../backend/
      Handler: dist/handlers/auth/mfa-handlers.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/mfa-check
            Method: POST

  MfaChallengeVerifyFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-mfa-challenge-verify'
      CodeUri: ../backend/
      Handler: dist/handlers/auth/mfa-handlers.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/mfa-challenge-verify
            Method: POST

  MfaVerifyLoginFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-mfa-verify-login'
      CodeUri: ../backend/
      Handler: dist/handlers/auth/mfa-handlers.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/mfa-verify-login
            Method: POST

  MfaListFactorsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-mfa-list-factors'
      CodeUri: ../backend/
      Handler: dist/handlers/auth/mfa-handlers.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/mfa-list-factors
            Method: POST

  MfaUnenrollFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-mfa-unenroll'
      CodeUri: ../backend/
      Handler: dist/handlers/auth/mfa-handlers.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/mfa-unenroll
            Method: POST

  SelfRegisterFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-self-register'
      CodeUri: ../backend/
      Handler: dist/handlers/auth/self-register.handler
      Timeout: 60
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/self-register
            Method: POST
            Auth:
              Authorizer: NONE

  VerifyTvTokenFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-verify-tv-token'
      CodeUri: ../backend/
      Handler: dist/handlers/auth/verify-tv-token.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/verify-tv-token
            Method: POST

  WebauthnAuthenticateFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-webauthn-authenticate'
      CodeUri: ../backend/
      Handler: dist/handlers/auth/webauthn-authenticate.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/webauthn-authenticate
            Method: POST

  WebauthnCheckFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-webauthn-check'
      CodeUri: ../backend/
      Handler: dist/handlers/auth/webauthn-check-standalone.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/webauthn-check
            Method: POST

  WebauthnRegisterFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-webauthn-register'
      CodeUri: ../backend/
      Handler: dist/handlers/auth/webauthn-register.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/webauthn-register
            Method: POST

  ListAwsCredentialsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-list-aws-credentials'
      CodeUri: ../backend/
      Handler: dist/handlers/aws/list-aws-credentials.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/list-aws-credentials
            Method: POST

  SaveAwsCredentialsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-save-aws-credentials'
      CodeUri: ../backend/
      Handler: dist/handlers/aws/save-aws-credentials.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/save-aws-credentials
            Method: POST

  UpdateAwsCredentialsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-update-aws-credentials'
      CodeUri: ../backend/
      Handler: dist/handlers/aws/update-aws-credentials.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/update-aws-credentials
            Method: POST

  AzureActivityLogsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-azure-activity-logs'
      CodeUri: ../backend/
      Handler: dist/handlers/azure/azure-activity-logs.handler
      Timeout: 60
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/azure-activity-logs
            Method: POST

  AzureComplianceScanFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-azure-compliance-scan'
      CodeUri: ../backend/
      Handler: dist/handlers/azure/azure-compliance-scan.handler
      Timeout: 300
      MemorySize: 1024
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/azure-compliance-scan
            Method: POST

  AzureCostOptimizationFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-azure-cost-optimization'
      CodeUri: ../backend/
      Handler: dist/handlers/azure/azure-cost-optimization.handler
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/azure-cost-optimization
            Method: POST

  AzureDefenderScanFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-azure-defender-scan'
      CodeUri: ../backend/
      Handler: dist/handlers/azure/azure-defender-scan.handler
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/azure-defender-scan
            Method: POST

  AzureDetectAnomaliesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-azure-detect-anomalies'
      CodeUri: ../backend/
      Handler: dist/handlers/azure/azure-detect-anomalies.handler
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/azure-detect-anomalies
            Method: POST

  AzureFetchCostsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-azure-fetch-costs'
      CodeUri: ../backend/
      Handler: dist/handlers/azure/azure-fetch-costs.handler
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/azure-fetch-costs
            Method: POST

  AzureFetchEdgeServicesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-azure-fetch-edge-services'
      CodeUri: ../backend/
      Handler: dist/handlers/azure/azure-fetch-edge-services.handler
      Timeout: 60
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/azure-fetch-edge-services
            Method: POST

  AzureFetchMonitorMetricsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-azure-fetch-monitor-metrics'
      CodeUri: ../backend/
      Handler: dist/handlers/azure/azure-fetch-monitor-metrics.handler
      Timeout: 60
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/azure-fetch-monitor-metrics
            Method: POST

  AzureOauthCallbackFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-azure-oauth-callback'
      CodeUri: ../backend/
      Handler: dist/handlers/azure/azure-oauth-callback.handler
      Timeout: 60
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/azure-oauth-callback
            Method: POST

  AzureOauthInitiateFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-azure-oauth-initiate'
      CodeUri: ../backend/
      Handler: dist/handlers/azure/azure-oauth-initiate.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/azure-oauth-initiate
            Method: POST

  AzureOauthRefreshFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-azure-oauth-refresh'
      CodeUri: ../backend/
      Handler: dist/handlers/azure/azure-oauth-refresh.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/azure-oauth-refresh
            Method: POST

  AzureOauthRevokeFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-azure-oauth-revoke'
      CodeUri: ../backend/
      Handler: dist/handlers/azure/azure-oauth-revoke.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/azure-oauth-revoke
            Method: POST

  AzureReservationsAnalyzerFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-azure-reservations-analyzer'
      CodeUri: ../backend/
      Handler: dist/handlers/azure/azure-reservations-analyzer.handler
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/azure-reservations-analyzer
            Method: POST

  AzureResourceInventoryFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-azure-resource-inventory'
      CodeUri: ../backend/
      Handler: dist/handlers/azure/azure-resource-inventory.handler
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/azure-resource-inventory
            Method: POST

  AzureSecurityScanFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-azure-security-scan'
      CodeUri: ../backend/
      Handler: dist/handlers/azure/azure-security-scan.handler
      Timeout: 300
      MemorySize: 1024
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/azure-security-scan
            Method: POST

  AzureWellArchitectedScanFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-azure-well-architected-scan'
      CodeUri: ../backend/
      Handler: dist/handlers/azure/azure-well-architected-scan.handler
      Timeout: 300
      MemorySize: 512
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/azure-well-architected-scan
            Method: POST

  DebugAzureCostsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-debug-azure-costs'
      CodeUri: ../backend/
      Handler: dist/handlers/azure/debug-azure-costs.handler

  DeleteAzureCredentialsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-delete-azure-credentials'
      CodeUri: ../backend/
      Handler: dist/handlers/azure/delete-azure-credentials.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/delete-azure-credentials
            Method: POST

  ListAzureCredentialsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-list-azure-credentials'
      CodeUri: ../backend/
      Handler: dist/handlers/azure/list-azure-credentials.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/list-azure-credentials
            Method: POST

  SaveAzureCredentialsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-save-azure-credentials'
      CodeUri: ../backend/
      Handler: dist/handlers/azure/save-azure-credentials.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/save-azure-credentials
            Method: POST

  StartAzureSecurityScanFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-start-azure-security-scan'
      CodeUri: ../backend/
      Handler: dist/handlers/azure/start-azure-security-scan.handler
      Timeout: 60
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/start-azure-security-scan
            Method: POST

  ValidateAzureCredentialsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-validate-azure-credentials'
      CodeUri: ../backend/
      Handler: dist/handlers/azure/validate-azure-credentials.handler
      Timeout: 60
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/validate-azure-credentials
            Method: POST

  ValidateAzurePermissionsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-validate-azure-permissions'
      CodeUri: ../backend/
      Handler: dist/handlers/azure/validate-azure-permissions.handler
      Timeout: 60
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/validate-azure-permissions
            Method: POST

  ListCloudCredentialsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-list-cloud-credentials'
      CodeUri: ../backend/
      Handler: dist/handlers/cloud/list-cloud-credentials.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/list-cloud-credentials
            Method: POST

  AnalyzeRiSpFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-analyze-ri-sp'
      CodeUri: ../backend/
      Handler: dist/handlers/cost/analyze-ri-sp.handler
      Timeout: 300
      MemorySize: 512
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/analyze-ri-sp
            Method: POST

  BudgetForecastFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-budget-forecast'
      CodeUri: ../backend/
      Handler: dist/handlers/cost/budget-forecast.handler
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/budget-forecast
            Method: POST

  CostOptimizationFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-cost-optimization'
      CodeUri: ../backend/
      Handler: dist/handlers/cost/cost-optimization.handler
      Timeout: 300
      MemorySize: 512
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/cost-optimization
            Method: POST

  FetchDailyCostsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-fetch-daily-costs'
      CodeUri: ../backend/
      Handler: dist/handlers/cost/fetch-daily-costs.handler
      Timeout: 300
      MemorySize: 512
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/fetch-daily-costs
            Method: POST

  FinopsCopilotFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-finops-copilot'
      CodeUri: ../backend/
      Handler: dist/handlers/cost/finops-copilot-v2.handler
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/finops-copilot
            Method: POST

  GenerateCostForecastFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-generate-cost-forecast'
      CodeUri: ../backend/
      Handler: dist/handlers/cost/generate-cost-forecast.handler
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/generate-cost-forecast
            Method: POST

  GetRiSpAnalysisFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-get-ri-sp-analysis'
      CodeUri: ../backend/
      Handler: dist/handlers/cost/get-ri-sp-analysis.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/get-ri-sp-analysis
            Method: POST

  GetRiSpDataFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-get-ri-sp-data'
      CodeUri: ../backend/
      Handler: dist/handlers/cost/get-ri-sp-data.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/get-ri-sp-data
            Method: POST

  ListRiSpHistoryFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-list-ri-sp-history'
      CodeUri: ../backend/
      Handler: dist/handlers/cost/list-ri-sp-history.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/list-ri-sp-history
            Method: POST

  MlWasteDetectionFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-ml-waste-detection'
      CodeUri: ../backend/
      Handler: dist/handlers/cost/ml-waste-detection.handler
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/ml-waste-detection
            Method: POST

  RiSpAnalyzerFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-ri-sp-analyzer'
      CodeUri: ../backend/
      Handler: dist/handlers/cost/ri-sp-analyzer.handler
      Timeout: 300
      MemorySize: 512
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/ri-sp-analyzer
            Method: POST

  SaveRiSpAnalysisFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-save-ri-sp-analysis'
      CodeUri: ../backend/
      Handler: dist/handlers/cost/save-ri-sp-analysis.handler

  GetExecutiveDashboardFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-get-executive-dashboard'
      CodeUri: ../backend/
      Handler: dist/handlers/dashboard/get-executive-dashboard.handler
      Timeout: 60
      MemorySize: 512
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/get-executive-dashboard
            Method: POST

  GetExecutiveDashboardPublicFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-get-executive-dashboard-public'
      CodeUri: ../backend/
      Handler: dist/handlers/dashboard/get-executive-dashboard-public.handler
      Timeout: 60
      MemorySize: 512
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/get-executive-dashboard-public
            Method: POST
            Auth:
              Authorizer: NONE

  ManageTvTokensFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-manage-tv-tokens'
      CodeUri: ../backend/
      Handler: dist/handlers/dashboard/manage-tv-tokens.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/manage-tv-tokens
            Method: POST

  CleanupCostDataFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-cleanup-cost-data'
      CodeUri: ../backend/
      Handler: dist/handlers/data/cleanup-cost-data.handler
      Timeout: 300

  MutateTableFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-mutate-table'
      CodeUri: ../backend/
      Handler: dist/handlers/data/mutate-table.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/mutate-table
            Method: POST

  QueryTableFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-query-table'
      CodeUri: ../backend/
      Handler: dist/handlers/data/query-table.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/query-table
            Method: POST

  TicketAttachmentsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-ticket-attachments'
      CodeUri: ../backend/
      Handler: dist/handlers/data/ticket-attachments.handler
      Timeout: 60
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/ticket-attachments
            Method: POST

  TicketManagementFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-ticket-management'
      CodeUri: ../backend/
      Handler: dist/handlers/data/ticket-management.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/ticket-management
            Method: POST

  CheckDailyCostsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-check-daily-costs'
      CodeUri: ../backend/
      Handler: dist/handlers/debug/check-daily-costs.handler

  DiagnoseCostDashboardFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-diagnose-cost-dashboard'
      CodeUri: ../backend/
      Handler: dist/handlers/debug/diagnose-cost-dashboard.handler

  InvestigateDataMismatchFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-investigate-data-mismatch'
      CodeUri: ../backend/
      Handler: dist/handlers/debug/investigate-data-mismatch.handler

  CloudformationWebhookFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-cloudformation-webhook'
      CodeUri: ../backend/
      Handler: dist/handlers/integrations/cloudformation-webhook.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/cloudformation-webhook
            Method: POST
            Auth:
              Authorizer: NONE

  CreateJiraTicketFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-create-jira-ticket'
      CodeUri: ../backend/
      Handler: dist/handlers/integrations/create-jira-ticket.handler
      Timeout: 60
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/create-jira-ticket
            Method: POST

  AutoCleanupStuckScansFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-auto-cleanup-stuck-scans'
      CodeUri: ../backend/
      Handler: dist/handlers/jobs/auto-cleanup-stuck-scans.handler
      Timeout: 300

  CleanupExpiredExternalIdsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-cleanup-expired-external-ids'
      CodeUri: ../backend/
      Handler: dist/handlers/jobs/cleanup-expired-external-ids.handler
      Timeout: 60

  CleanupExpiredOauthStatesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-cleanup-expired-oauth-states'
      CodeUri: ../backend/
      Handler: dist/handlers/jobs/cleanup-expired-oauth-states.handler
      Timeout: 60

  CleanupStuckScansFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-cleanup-stuck-scans'
      CodeUri: ../backend/
      Handler: dist/handlers/jobs/cleanup-stuck-scans.handler
      Timeout: 300

  ExecuteScheduledJobFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-execute-scheduled-job'
      CodeUri: ../backend/
      Handler: dist/handlers/jobs/execute-scheduled-job.handler
      Timeout: 300
      MemorySize: 512
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/execute-scheduled-job
            Method: POST

  InitialDataLoadFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-initial-data-load'
      CodeUri: ../backend/
      Handler: dist/handlers/jobs/initial-data-load.handler
      Timeout: 300

  ListBackgroundJobsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-list-background-jobs'
      CodeUri: ../backend/
      Handler: dist/handlers/jobs/list-background-jobs.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/list-background-jobs
            Method: POST

  ProcessBackgroundJobsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-process-background-jobs'
      CodeUri: ../backend/
      Handler: dist/handlers/jobs/process-background-jobs.handler
      Timeout: 300
      MemorySize: 512
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/process-background-jobs
            Method: POST

  ProcessEventsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-process-events'
      CodeUri: ../backend/
      Handler: dist/handlers/jobs/process-events.handler
      Timeout: 300

  ScheduledScanExecutorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-scheduled-scan-executor'
      CodeUri: ../backend/
      Handler: dist/handlers/jobs/scheduled-scan-executor.handler
      Timeout: 300
      MemorySize: 512
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/scheduled-scan-executor
            Method: POST

  ScheduledViewRefreshFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-scheduled-view-refresh'
      CodeUri: ../backend/
      Handler: dist/handlers/jobs/scheduled-view-refresh.handler
      Timeout: 300

  SendScheduledEmailsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-send-scheduled-emails'
      CodeUri: ../backend/
      Handler: dist/handlers/jobs/send-scheduled-emails.handler
      Timeout: 120

  SyncResourceInventoryFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-sync-resource-inventory'
      CodeUri: ../backend/
      Handler: dist/handlers/jobs/sync-resource-inventory.handler
      Timeout: 300

  IncrementArticleHelpfulFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-increment-article-helpful'
      CodeUri: ../backend/
      Handler: dist/handlers/kb/increment-article-helpful.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/increment-article-helpful
            Method: POST

  IncrementArticleViewsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-increment-article-views'
      CodeUri: ../backend/
      Handler: dist/handlers/kb/increment-article-views.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/increment-article-views
            Method: POST

  KbAiSuggestionsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-kb-ai-suggestions'
      CodeUri: ../backend/
      Handler: dist/handlers/kb/kb-ai-suggestions.handler
      Timeout: 60
      MemorySize: 512
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/kb-ai-suggestions
            Method: POST

  KbAnalyticsDashboardFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-kb-analytics-dashboard'
      CodeUri: ../backend/
      Handler: dist/handlers/kb/kb-analytics-dashboard.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/kb-analytics-dashboard
            Method: POST

  KbArticleTrackingFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-kb-article-tracking'
      CodeUri: ../backend/
      Handler: dist/handlers/kb/kb-article-tracking.handler

  KbExportPdfFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-kb-export-pdf'
      CodeUri: ../backend/
      Handler: dist/handlers/kb/kb-export-pdf.handler
      Timeout: 60
      MemorySize: 512
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/kb-export-pdf
            Method: POST

  TrackArticleViewDetailedFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-track-article-view-detailed'
      CodeUri: ../backend/
      Handler: dist/handlers/kb/track-article-view-detailed.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/track-article-view-detailed
            Method: POST

  AdminSyncLicenseFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-admin-sync-license'
      CodeUri: ../backend/
      Handler: dist/handlers/license/admin-sync-license.handler
      Timeout: 60
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/admin-sync-license
            Method: POST

  CleanupSeatsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-cleanup-seats'
      CodeUri: ../backend/
      Handler: dist/handlers/license/cleanup-seats.handler
      Timeout: 60

  ConfigureLicenseFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-configure-license'
      CodeUri: ../backend/
      Handler: dist/handlers/license/configure-license.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/configure-license
            Method: POST

  DailyLicenseValidationFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-daily-license-validation'
      CodeUri: ../backend/
      Handler: dist/handlers/license/daily-license-validation.handler
      Timeout: 120

  ManageSeatAssignmentsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-manage-seat-assignments'
      CodeUri: ../backend/
      Handler: dist/handlers/license/manage-seat-assignments.handler

  ManageSeatsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-manage-seats'
      CodeUri: ../backend/
      Handler: dist/handlers/license/manage-seats.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/manage-seats
            Method: POST

  ScheduledLicenseSyncFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-scheduled-license-sync'
      CodeUri: ../backend/
      Handler: dist/handlers/license/scheduled-license-sync.handler
      Timeout: 120

  SyncLicenseFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-sync-license'
      CodeUri: ../backend/
      Handler: dist/handlers/license/sync-license.handler
      Timeout: 60
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/sync-license
            Method: POST

  ValidateLicenseFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-validate-license'
      CodeUri: ../backend/
      Handler: dist/handlers/license/validate-license.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/validate-license
            Method: POST

  MaintenanceAutoCleanupStuckScansFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-maintenance-auto-cleanup-stuck-scans'
      CodeUri: ../backend/
      Handler: dist/handlers/maintenance/auto-cleanup-stuck-scans.handler
      Timeout: 300

  CleanupStuckScansSimpleFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-cleanup-stuck-scans-simple'
      CodeUri: ../backend/
      Handler: dist/handlers/maintenance/cleanup-stuck-scans-simple.handler
      Timeout: 300

  AiPrioritizationFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-ai-prioritization'
      CodeUri: ../backend/
      Handler: dist/handlers/ml/ai-prioritization.handler
      Timeout: 120
      MemorySize: 512

  DetectAnomaliesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-detect-anomalies'
      CodeUri: ../backend/
      Handler: dist/handlers/ml/detect-anomalies.handler
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/detect-anomalies
            Method: POST

  GenerateAiInsightsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-generate-ai-insights'
      CodeUri: ../backend/
      Handler: dist/handlers/ml/generate-ai-insights.handler
      Timeout: 120
      MemorySize: 512

  IntelligentAlertsAnalyzerFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-intelligent-alerts-analyzer'
      CodeUri: ../backend/
      Handler: dist/handlers/ml/intelligent-alerts-analyzer.handler
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/intelligent-alerts-analyzer
            Method: POST

  PredictIncidentsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-predict-incidents'
      CodeUri: ../backend/
      Handler: dist/handlers/ml/predict-incidents.handler
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/predict-incidents
            Method: POST

  AlertsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-alerts'
      CodeUri: ../backend/
      Handler: dist/handlers/monitoring/alerts.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/alerts
            Method: POST

  AutoAlertsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-auto-alerts'
      CodeUri: ../backend/
      Handler: dist/handlers/monitoring/auto-alerts.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/auto-alerts
            Method: POST

  AwsRealtimeMetricsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-aws-realtime-metrics'
      CodeUri: ../backend/
      Handler: dist/handlers/monitoring/aws-realtime-metrics.handler
      Timeout: 60
      MemorySize: 512
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/aws-realtime-metrics
            Method: POST

  CheckAlertRulesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-check-alert-rules'
      CodeUri: ../backend/
      Handler: dist/handlers/monitoring/check-alert-rules.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/check-alert-rules
            Method: POST

  EndpointMonitorCheckFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-endpoint-monitor-check'
      CodeUri: ../backend/
      Handler: dist/handlers/monitoring/endpoint-monitor-check.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/endpoint-monitor-check
            Method: POST

  ErrorAggregatorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-error-aggregator'
      CodeUri: ../backend/
      Handler: dist/handlers/monitoring/error-aggregator.handler

  FetchCloudwatchMetricsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-fetch-cloudwatch-metrics'
      CodeUri: ../backend/
      Handler: dist/handlers/monitoring/fetch-cloudwatch-metrics.handler
      Timeout: 60
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/fetch-cloudwatch-metrics
            Method: POST

  FetchEdgeServicesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-fetch-edge-services'
      CodeUri: ../backend/
      Handler: dist/handlers/monitoring/fetch-edge-services.handler
      Timeout: 60
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/fetch-edge-services
            Method: POST

  GenerateErrorFixPromptFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-generate-error-fix-prompt'
      CodeUri: ../backend/
      Handler: dist/handlers/monitoring/generate-error-fix-prompt.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/generate-error-fix-prompt
            Method: POST

  GetLambdaHealthFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-get-lambda-health'
      CodeUri: ../backend/
      Handler: dist/handlers/monitoring/get-lambda-health.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/get-lambda-health
            Method: POST

  GetPlatformMetricsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-get-platform-metrics'
      CodeUri: ../backend/
      Handler: dist/handlers/monitoring/get-platform-metrics.handler
      Timeout: 60
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/get-platform-metrics
            Method: POST

  GetRecentErrorsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-get-recent-errors'
      CodeUri: ../backend/
      Handler: dist/handlers/monitoring/get-recent-errors.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/get-recent-errors
            Method: POST

  HealthCheckFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-health-check'
      CodeUri: ../backend/
      Handler: dist/handlers/monitoring/health-check.handler

  LambdaHealthCheckFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-lambda-health-check'
      CodeUri: ../backend/
      Handler: dist/handlers/monitoring/lambda-health-check.handler

  LogFrontendErrorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-log-frontend-error'
      CodeUri: ../backend/
      Handler: dist/handlers/monitoring/log-frontend-error.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/log-frontend-error
            Method: POST
            Auth:
              Authorizer: NONE

  MonitoredEndpointsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-monitored-endpoints'
      CodeUri: ../backend/
      Handler: dist/handlers/monitoring/monitored-endpoints.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/monitored-endpoints
            Method: POST

  TestLambdaMetricsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-test-lambda-metrics'
      CodeUri: ../backend/
      Handler: dist/handlers/monitoring/test-lambda-metrics.handler

  GetCommunicationLogsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-get-communication-logs'
      CodeUri: ../backend/
      Handler: dist/handlers/notifications/get-communication-logs.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/get-communication-logs
            Method: POST

  ManageEmailPreferencesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-manage-email-preferences'
      CodeUri: ../backend/
      Handler: dist/handlers/notifications/manage-email-preferences.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/manage-email-preferences
            Method: POST

  SendEmailFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-send-email'
      CodeUri: ../backend/
      Handler: dist/handlers/notifications/send-email.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/send-email
            Method: POST

  SendNotificationFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-send-notification'
      CodeUri: ../backend/
      Handler: dist/handlers/notifications/send-notification.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/send-notification
            Method: POST

  CreateOrganizationAccountFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-create-organization-account'
      CodeUri: ../backend/
      Handler: dist/handlers/organizations/create-organization-account.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/create-organization-account
            Method: POST

  SyncOrganizationAccountsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-sync-organization-accounts'
      CodeUri: ../backend/
      Handler: dist/handlers/organizations/sync-organization-accounts.handler
      Timeout: 60
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/sync-organization-accounts
            Method: POST

  CheckOrganizationFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-check-organization'
      CodeUri: ../backend/
      Handler: dist/handlers/profiles/check-organization.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/check-organization
            Method: POST

  CreateWithOrganizationFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-create-with-organization'
      CodeUri: ../backend/
      Handler: dist/handlers/profiles/create-with-organization.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/create-with-organization
            Method: POST

  GetUserOrganizationFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-get-user-organization'
      CodeUri: ../backend/
      Handler: dist/handlers/profiles/get-user-organization.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/get-user-organization
            Method: POST

  GenerateExcelReportFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-generate-excel-report'
      CodeUri: ../backend/
      Handler: dist/handlers/reports/generate-excel-report.handler
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/generate-excel-report
            Method: POST

  GeneratePdfReportFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-generate-pdf-report'
      CodeUri: ../backend/
      Handler: dist/handlers/reports/generate-pdf-report.handler
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/generate-pdf-report
            Method: POST

  GenerateRemediationScriptFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-generate-remediation-script'
      CodeUri: ../backend/
      Handler: dist/handlers/reports/generate-remediation-script.handler
      Timeout: 60
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/generate-remediation-script
            Method: POST

  GenerateSecurityPdfFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-generate-security-pdf'
      CodeUri: ../backend/
      Handler: dist/handlers/reports/generate-security-pdf.handler
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/generate-security-pdf
            Method: POST

  SecurityScanPdfExportFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-security-scan-pdf-export'
      CodeUri: ../backend/
      Handler: dist/handlers/reports/security-scan-pdf-export.handler
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/security-scan-pdf-export
            Method: POST

  AnalyzeCloudtrailFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-analyze-cloudtrail'
      CodeUri: ../backend/
      Handler: dist/handlers/security/analyze-cloudtrail.handler
      Timeout: 300
      MemorySize: 512
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/analyze-cloudtrail
            Method: POST

  ComplianceScanFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-compliance-scan'
      CodeUri: ../backend/
      Handler: dist/handlers/security/compliance-scan.handler
      Timeout: 300
      MemorySize: 1024
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/compliance-scan
            Method: POST

  CreateRemediationTicketFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-create-remediation-ticket'
      CodeUri: ../backend/
      Handler: dist/handlers/security/create-remediation-ticket.handler

  DriftDetectionFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-drift-detection'
      CodeUri: ../backend/
      Handler: dist/handlers/security/drift-detection.handler
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/drift-detection
            Method: POST

  FetchCloudtrailFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-fetch-cloudtrail'
      CodeUri: ../backend/
      Handler: dist/handlers/security/fetch-cloudtrail.handler
      Timeout: 60
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/fetch-cloudtrail
            Method: POST

  GetComplianceHistoryFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-get-compliance-history'
      CodeUri: ../backend/
      Handler: dist/handlers/security/get-compliance-history.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/get-compliance-history
            Method: POST

  GetComplianceScanStatusFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-get-compliance-scan-status'
      CodeUri: ../backend/
      Handler: dist/handlers/security/get-compliance-scan-status.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/get-compliance-scan-status
            Method: POST

  GetFindingsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-get-findings'
      CodeUri: ../backend/
      Handler: dist/handlers/security/get-findings.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/get-findings
            Method: POST

  GetSecurityPostureFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-get-security-posture'
      CodeUri: ../backend/
      Handler: dist/handlers/security/get-security-posture.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/get-security-posture
            Method: POST

  GuarddutyScanFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-guardduty-scan'
      CodeUri: ../backend/
      Handler: dist/handlers/security/guardduty-scan.handler
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/guardduty-scan
            Method: POST

  IamBehaviorAnalysisFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-iam-behavior-analysis'
      CodeUri: ../backend/
      Handler: dist/handlers/security/iam-behavior-analysis.handler
      Timeout: 120
      MemorySize: 512

  IamDeepAnalysisFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-iam-deep-analysis'
      CodeUri: ../backend/
      Handler: dist/handlers/security/iam-deep-analysis.handler
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/iam-deep-analysis
            Method: POST

  LateralMovementDetectionFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-lateral-movement-detection'
      CodeUri: ../backend/
      Handler: dist/handlers/security/lateral-movement-detection.handler
      Timeout: 120
      MemorySize: 512
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/lateral-movement-detection
            Method: POST

  SecurityScanFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-security-scan'
      CodeUri: ../backend/
      Handler: dist/handlers/security/security-scan.handler
      Timeout: 300
      MemorySize: 1024
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/security-scan
            Method: POST

  StartAnalyzeCloudtrailFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-start-analyze-cloudtrail'
      CodeUri: ../backend/
      Handler: dist/handlers/security/start-analyze-cloudtrail.handler
      Timeout: 60

  StartCloudtrailAnalysisFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-start-cloudtrail-analysis'
      CodeUri: ../backend/
      Handler: dist/handlers/security/start-cloudtrail-analysis.handler
      Timeout: 60
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/start-cloudtrail-analysis
            Method: POST

  StartComplianceScanFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-start-compliance-scan'
      CodeUri: ../backend/
      Handler: dist/handlers/security/start-compliance-scan.handler
      Timeout: 60
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/start-compliance-scan
            Method: POST

  StartSecurityScanFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-start-security-scan'
      CodeUri: ../backend/
      Handler: dist/handlers/security/start-security-scan.handler
      Timeout: 60
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/start-security-scan
            Method: POST

  ValidateAwsCredentialsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-validate-aws-credentials'
      CodeUri: ../backend/
      Handler: dist/handlers/security/validate-aws-credentials.handler
      Timeout: 60
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/validate-aws-credentials
            Method: POST

  ValidatePermissionsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-validate-permissions'
      CodeUri: ../backend/
      Handler: dist/handlers/security/validate-permissions.handler
      Timeout: 60
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/validate-permissions
            Method: POST

  ValidateWafSecurityFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-validate-waf-security'
      CodeUri: ../backend/
      Handler: dist/handlers/security/validate-waf-security.handler

  WafDashboardApiFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-waf-dashboard-api'
      CodeUri: ../backend/
      Handler: dist/handlers/security/waf-dashboard-api.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/waf-dashboard-api
            Method: POST

  WafLogForwarderFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-waf-log-forwarder'
      CodeUri: ../backend/
      Handler: dist/handlers/security/waf-log-forwarder.handler

  WafLogProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-waf-log-processor'
      CodeUri: ../backend/
      Handler: dist/handlers/security/waf-log-processor.handler

  WafSetupMonitoringFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-waf-setup-monitoring'
      CodeUri: ../backend/
      Handler: dist/handlers/security/waf-setup-monitoring.handler
      Timeout: 60
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/waf-setup-monitoring
            Method: POST

  WafThreatAnalyzerFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-waf-threat-analyzer'
      CodeUri: ../backend/
      Handler: dist/handlers/security/waf-threat-analyzer.handler

  WafUnblockExpiredFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-waf-unblock-expired'
      CodeUri: ../backend/
      Handler: dist/handlers/security/waf-unblock-expired.handler
      Timeout: 60

  WellArchitectedScanFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-well-architected-scan'
      CodeUri: ../backend/
      Handler: dist/handlers/security/well-architected-scan.handler
      Timeout: 300
      MemorySize: 512
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/well-architected-scan
            Method: POST

  StorageDownloadFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-storage-download'
      CodeUri: ../backend/
      Handler: dist/handlers/storage/storage-handlers.handler
      Timeout: 60
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/storage-download
            Method: POST

  StorageDeleteFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-storage-delete'
      CodeUri: ../backend/
      Handler: dist/handlers/storage/storage-handlers.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/storage-delete
            Method: POST

  UploadAttachmentFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-upload-attachment'
      CodeUri: ../backend/
      Handler: dist/handlers/storage/storage-handlers.handler
      Timeout: 60
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/upload-attachment
            Method: POST

  AddStatusColumnFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-add-status-column'
      CodeUri: ../backend/
      Handler: dist/handlers/system/add-status-column.handler

  CheckMigrationsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-check-migrations'
      CodeUri: ../backend/
      Handler: dist/handlers/system/check-migrations.handler

  DbInitFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-db-init'
      CodeUri: ../backend/
      Handler: dist/handlers/system/db-init.handler
      Timeout: 300
      MemorySize: 512
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/db-init
            Method: POST

  DebugOrgQueryFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-debug-org-query'
      CodeUri: ../backend/
      Handler: dist/handlers/system/debug-org-query.handler

  FixAzureConstraintsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-fix-azure-constraints'
      CodeUri: ../backend/
      Handler: dist/handlers/system/fix-azure-constraints.handler

  ListTablesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-list-tables'
      CodeUri: ../backend/
      Handler: dist/handlers/system/list-tables.handler

  RunMigrationsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-run-migrations'
      CodeUri: ../backend/
      Handler: dist/handlers/system/run-migrations.handler
      Timeout: 300

  RunSqlMigrationFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-run-sql-migration'
      CodeUri: ../backend/
      Handler: dist/handlers/system/run-sql-migration.handler
      Timeout: 300

  NotificationSettingsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-notification-settings'
      CodeUri: ../backend/
      Handler: dist/handlers/user/notification-settings.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/notification-settings
            Method: POST

  WebsocketConnectFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-websocket-connect'
      CodeUri: ../backend/
      Handler: dist/handlers/websocket/connect.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/websocket-connect
            Method: POST
            Auth:
              Authorizer: NONE

  WebsocketDisconnectFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-websocket-disconnect'
      CodeUri: ../backend/
      Handler: dist/handlers/websocket/disconnect.handler
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref Api
            Path: /api/functions/websocket-disconnect
            Method: POST
            Auth:
              Authorizer: NONE
  # ==========================================================================
  # OUTPUTS
  # ==========================================================================
Outputs:
  ApiEndpoint:
    Description: API Gateway endpoint URL
    Value: !Sub 'https://${Api}.execute-api.${AWS::Region}.amazonaws.com/prod'

  UserPoolId:
    Description: Cognito User Pool ID
    Value: !Ref UserPool

  UserPoolClientId:
    Description: Cognito User Pool Client ID
    Value: !Ref UserPoolClient

  DatabaseEndpoint:
    Description: RDS endpoint
    Value: !GetAtt Database.Endpoint.Address

  DatabaseSecretArn:
    Description: Database secret ARN for CI/CD
    Value: !Ref DatabaseSecret

  VpcId:
    Description: VPC ID
    Value: !Ref VPC

  PrivateSubnet1:
    Description: Private Subnet 1 ID
    Value: !Ref PrivateSubnet1

  PrivateSubnet2:
    Description: Private Subnet 2 ID
    Value: !Ref PrivateSubnet2

  LambdaSecurityGroupId:
    Description: Lambda Security Group ID
    Value: !Ref LambdaSecurityGroup

  FrontendBucketName:
    Description: S3 bucket for frontend
    Value: !Ref FrontendBucket

  CloudFrontDistributionId:
    Description: CloudFront distribution ID
    Value: !Ref CloudFrontDistribution

  CloudFrontDomainName:
    Description: CloudFront domain name
    Value: !GetAtt CloudFrontDistribution.DomainName
