name: Deploy to Production

on:
  push:
    branches: [production]
    paths:
      - 'backend/**'

env:
  NODE_VERSION: '18'
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: '523115032346'
  LAMBDA_PREFIX: evo-uds-v3-prod
  SNS_TOPIC_ARN: arn:aws:sns:us-east-1:523115032346:evo-pipeline-notifications-production
  CRITICAL_LAMBDAS: save-aws-credentials,validate-aws-credentials,security-scan,mfa-enroll,mfa-verify-login

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    outputs:
      deploy_all: ${{ steps.changes.outputs.deploy_all }}
      handlers: ${{ steps.changes.outputs.handlers }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install, test and build
        run: |
          cd backend
          npm ci
          npx prisma generate
          npm test -- --run --passWithNoTests
          npm run build
        env:
          NODE_ENV: test

      - name: Detect changed files
        id: changes
        run: |
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git diff --name-only HEAD)
          CORE_PATTERN="^backend/src/(lib|types)/|^backend/prisma/|^backend/package"
          
          if echo "$CHANGED_FILES" | grep -qE "$CORE_PATTERN"; then
            echo "deploy_all=true" >> $GITHUB_OUTPUT
          else
            echo "deploy_all=false" >> $GITHUB_OUTPUT
            HANDLERS=$(echo "$CHANGED_FILES" | grep "^backend/src/handlers/" | sed 's|backend/src/handlers/||' | sed 's|\.ts$||' | sort -u | tr '\n' ' ')
            echo "handlers=$HANDLERS" >> $GITHUB_OUTPUT
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-dist
          path: backend/dist/
          retention-days: 1

  deploy:
    name: Deploy to Production
    needs: build
    runs-on: ubuntu-latest
    environment: 
      name: production
      url: https://api-evo.ai.udstec.io
    
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: backend-dist
          path: backend/dist/

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_PRODUCTION }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy Lambdas
        run: |
          chmod +x cicd/scripts/deploy-changed-lambdas.sh
          ./cicd/scripts/deploy-changed-lambdas.sh
        env:
          DEPLOY_ALL: ${{ needs.build.outputs.deploy_all }}
          CHANGED_HANDLERS: ${{ needs.build.outputs.handlers }}
          LAMBDA_PREFIX: ${{ env.LAMBDA_PREFIX }}
          REGION: ${{ env.AWS_REGION }}

      - name: Health check critical Lambdas
        run: |
          echo "üè• Running production health checks..."
          FAILED=0
          IFS=',' read -ra LAMBDAS <<< "${{ env.CRITICAL_LAMBDAS }}"
          
          for lambda in "${LAMBDAS[@]}"; do
            FULL_NAME="${{ env.LAMBDA_PREFIX }}-${lambda}"
            if aws lambda invoke --function-name "$FULL_NAME" \
              --payload '{"requestContext":{"http":{"method":"OPTIONS"}}}' \
              --region ${{ env.AWS_REGION }} /tmp/health.json 2>/dev/null && \
              grep -q '"statusCode":200' /tmp/health.json; then
              echo "‚úÖ $FULL_NAME"
            else
              echo "‚ùå $FULL_NAME"
              FAILED=$((FAILED + 1))
            fi
          done
          
          [ $FAILED -eq 0 ] || exit 1

      - name: Send email notification
        if: always()
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            SUBJECT="‚úÖ EVO Production Deploy Successful"
            MESSAGE="Deploy completed. All health checks passed."
          else
            SUBJECT="üö® EVO Production Deploy FAILED"
            MESSAGE="CRITICAL: Deploy failed! Check: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi
          
          aws sns publish \
            --topic-arn "${{ env.SNS_TOPIC_ARN }}" \
            --subject "$SUBJECT" \
            --message "$MESSAGE

Commit: ${{ github.sha }}
Author: ${{ github.actor }}
Branch: ${{ github.ref_name }}" \
            --region ${{ env.AWS_REGION }}
