version: 0.2

# AWS CodeBuild - SAM Build and Deploy
# Deploys Lambda functions using existing infrastructure

env:
  variables:
    SAM_CLI_TELEMETRY: 0

phases:
  install:
    runtime-versions:
      nodejs: 20
      python: 3.11
    commands:
      - echo "üì¶ Installing SAM CLI..."
      - pip install aws-sam-cli
      
      - echo "üì¶ Installing dependencies..."
      - npm install
      - npm install --prefix backend
      
      - echo "üîß Generating Prisma client..."
      - cd backend && npx prisma generate && cd ..

  pre_build:
    commands:
      - echo "üîç Determining environment..."
      - |
        if [ "$CODEBUILD_WEBHOOK_HEAD_REF" = "refs/heads/production" ] || [ "$BRANCH_NAME" = "production" ]; then
          export ENV="production"
          export AWS_ACCOUNT="523115032346"
          # Production infrastructure values
          export COGNITO_USER_POOL_ID="us-east-1_WVljEXXs9"
          export LAMBDA_SG_ID="sg-07ea931d32276e039"
          export PRIVATE_SUBNET_1="subnet-0af7face420b9f317"
          export PRIVATE_SUBNET_2="subnet-099b0fbc0a342fb0f"
          export LAYER_ARN="arn:aws:lambda:us-east-1:523115032346:layer:evo-prisma-deps-layer:1"
          export DATABASE_URL=$(aws ssm get-parameter --name "/evo/production/database-url" --with-decryption --query 'Parameter.Value' --output text 2>/dev/null || echo "")
        else
          export ENV="sandbox"
          export AWS_ACCOUNT="971354623291"
          # Sandbox infrastructure values (existing)
          export COGNITO_USER_POOL_ID="us-east-1_cnesJ48lR"
          export LAMBDA_SG_ID="sg-04eb71f681cc651ae"
          export PRIVATE_SUBNET_1="subnet-0dbb444e4ef54d211"
          export PRIVATE_SUBNET_2="subnet-05383447666913b7b"
          export LAYER_ARN="arn:aws:lambda:us-east-1:971354623291:layer:evo-prisma-deps-layer:92"
          export DATABASE_URL=$(aws ssm get-parameter --name "/evo/sandbox/database-url" --with-decryption --query 'Parameter.Value' --output text 2>/dev/null || echo "")
        fi
        echo "üåç Environment: $ENV"
        echo "üì¶ Using existing infrastructure"
        echo "üîó Layer: $LAYER_ARN"

  build:
    commands:
      - echo "üî® Building TypeScript..."
      - npm run build --prefix backend
      - npm run build
      
      - echo "üìù Generating SAM template..."
      - npx tsx scripts/generate-sam-template.ts
      
      # Using existing layer - no need to prepare dependencies
      # Layer ARN: arn:aws:lambda:us-east-1:971354623291:layer:evo-prisma-deps-layer:92
      
      - echo "üèóÔ∏è Building SAM application..."
      - sam build --template-file template.yaml

  post_build:
    commands:
      - echo "üöÄ Deploying SAM application..."
      - |
        sam deploy \
          --template-file .aws-sam/build/template.yaml \
          --stack-name evo-uds-v3-$ENV-lambdas \
          --s3-bucket evo-sam-artifacts-$AWS_ACCOUNT \
          --s3-prefix evo-uds-v3-$ENV \
          --region us-east-1 \
          --capabilities CAPABILITY_IAM CAPABILITY_AUTO_EXPAND \
          --parameter-overrides \
            "Environment=$ENV" \
            "ProjectName=evo-uds-v3" \
            "DatabaseUrl=$DATABASE_URL" \
            "CognitoUserPoolId=$COGNITO_USER_POOL_ID" \
            "LambdaSecurityGroupId=$LAMBDA_SG_ID" \
            "PrivateSubnet1Id=$PRIVATE_SUBNET_1" \
            "PrivateSubnet2Id=$PRIVATE_SUBNET_2" \
            "DependenciesLayerArn=$LAYER_ARN" \
          --no-confirm-changeset \
          --no-fail-on-empty-changeset
      
      - echo "üåê Deploying Frontend..."
      - |
        if [ "$ENV" = "sandbox" ]; then
          FRONTEND_BUCKET="evo-uds-v3-production-frontend-971354623291"
          CF_DIST_ID="E1PY7U3VNT6P1R"
        else
          FRONTEND_BUCKET="evo-uds-v3-prod-frontend-523115032346"
          CF_DIST_ID=""
        fi
        
        if [ -n "$FRONTEND_BUCKET" ]; then
          aws s3 sync dist/ s3://$FRONTEND_BUCKET/ --delete
          
          if [ -n "$CF_DIST_ID" ]; then
            aws cloudfront create-invalidation --distribution-id $CF_DIST_ID --paths "/*"
          fi
        fi
      
      - echo "‚úÖ Deployment completed!"

artifacts:
  files:
    - .aws-sam/build/template.yaml
    - dist/**/*
  discard-paths: no

cache:
  paths:
    - 'backend/node_modules/**/*'
    - 'node_modules/**/*'
    - '/root/.npm/**/*'
