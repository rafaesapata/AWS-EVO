// Schema Prisma baseado nas migrações Supabase
// Este schema será usado para gerar o cliente Prisma para acesso ao RDS PostgreSQL

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x", "rhel-openssl-3.0.x", "linux-arm64-openssl-1.0.x", "linux-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== CLOUD PROVIDER ENUM ====================

enum CloudProvider {
  AWS
  AZURE
  GCP
}

// ==================== ORGANIZAÇÕES & MULTI-TENANT ====================

model Organization {
  id                String   @id @default(uuid()) @db.Uuid
  name              String
  slug              String   @unique
  status            String   @default("active") // active, suspended, inactive
  contact_email     String?  // Primary contact email (set during self-registration)
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  updated_at        DateTime @updatedAt @db.Timestamptz(6)
  
  // Demo Mode - Modo de demonstração com dados fictícios
  demo_mode         Boolean  @default(false)
  demo_activated_at DateTime? @db.Timestamptz(6)
  demo_expires_at   DateTime? @db.Timestamptz(6)
  demo_activated_by String?  @db.Uuid
  
  // Relações
  profiles          Profile[]
  aws_credentials   AwsCredential[]
  azure_credentials AzureCredential[]
  aws_accounts      AwsAccount[]
  findings          Finding[]
  security_scans    SecurityScan[]
  scan_schedules    ScanSchedule[]
  background_jobs   BackgroundJob[]
  licenses          License[]
  kb_articles       KnowledgeBaseArticle[]
  remediation_tickets RemediationTicket[]
  demo_mode_audits  DemoModeAudit[]
  tags              Tag[]
  resource_tag_assignments ResourceTagAssignment[]
  tag_auto_rules    TagAutoRule[]
  
  @@index([demo_mode])
  @@index([status])
  @@map("organizations")
}

model Profile {
  id                String   @id @default(uuid()) @db.Uuid
  user_id           String   // Cognito user ID (text, not uuid)
  email             String
  name              String?  // Legacy column - use full_name instead
  organization_id   String   @db.Uuid
  role              String   @default("user")
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  updated_at        DateTime @updatedAt @db.Timestamptz(6)
  full_name         String?
  avatar_url        String?
  language          String?  @default("pt")
  timezone          String?  @default("America/Sao_Paulo")
  
  organization      Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  
  @@unique([user_id, organization_id])
  @@index([organization_id])
  @@index([email])
  @@map("profiles")
}

// ==================== AWS CREDENTIALS & ACCOUNTS ====================

model AwsCredential {
  id                    String   @id @default(uuid()) @db.Uuid
  organization_id       String   @db.Uuid
  account_id            String   @map("account_id") // 12-digit AWS account number
  account_name          String?
  access_key_id         String?
  secret_access_key     String?
  role_arn              String?
  external_id           String?
  session_token         String?
  region                String   @default("us-east-1")
  regions               String[]
  is_active             Boolean  @default(true)
  created_at            DateTime @default(now()) @db.Timestamptz(6)
  updated_at            DateTime @updatedAt @db.Timestamptz(6)
  
  organization          Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  security_scans        SecurityScan[]
  scan_schedules        ScanSchedule[]
  guardduty_findings    GuardDutyFinding[]
  
  @@index([organization_id])
  @@map("aws_credentials")
}

model AwsAccount {
  id                String   @id @default(uuid()) @db.Uuid
  organization_id   String   @db.Uuid
  account_id        String
  account_name      String
  email             String?
  status            String?
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  updated_at        DateTime @updatedAt @db.Timestamptz(6)
  
  organization      Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  
  @@unique([organization_id, account_id])
  @@map("aws_accounts")
}

// ==================== AZURE CREDENTIALS ====================

model AzureCredential {
  id                    String   @id @default(uuid()) @db.Uuid
  organization_id       String   @db.Uuid
  subscription_id       String   // Azure Subscription ID
  subscription_name     String?
  
  // Authentication type: 'service_principal' or 'oauth'
  auth_type             String   @default("service_principal")
  
  // Service Principal fields (used when auth_type = 'service_principal')
  tenant_id             String?  // Azure AD Tenant ID (optional for OAuth)
  client_id             String?  // Service Principal App ID (optional for OAuth)
  client_secret         String?  // Service Principal Secret (encrypted, optional for OAuth)
  
  // Certificate fields (used when auth_type = 'certificate')
  certificate_pem           String?  // Encrypted combined PEM (cert+key)
  certificate_thumbprint    String?  // SHA-1 thumbprint
  certificate_expires_at    DateTime? @db.Timestamptz(6) // Certificate expiration date
  
  // OAuth fields (used when auth_type = 'oauth')
  encrypted_refresh_token String? // Encrypted OAuth refresh token
  token_expires_at      DateTime? @db.Timestamptz(6) // When current access token expires
  oauth_tenant_id       String?  // Tenant ID from OAuth flow
  oauth_user_email      String?  // Email of user who authorized
  last_refresh_at       DateTime? @db.Timestamptz(6) // Last successful token refresh
  refresh_error         String?  // Error message if refresh failed
  
  // Common fields
  regions               String[] // Azure regions (e.g., eastus, westeurope)
  is_active             Boolean  @default(true)
  created_at            DateTime @default(now()) @db.Timestamptz(6)
  updated_at            DateTime @updatedAt @db.Timestamptz(6)
  
  organization          Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  security_scans        SecurityScan[] @relation("AzureSecurityScans")
  scan_schedules        ScanSchedule[] @relation("AzureScanSchedules")
  activity_events       AzureActivityEvent[]
  defender_findings     AzureDefenderFinding[]
  reservations          AzureReservation[]
  waf_events            AzureWafEvent[]
  
  @@unique([organization_id, subscription_id])
  @@index([organization_id])
  @@index([subscription_id])
  @@index([auth_type])
  @@map("azure_credentials")
}

// ==================== OAUTH STATE (CSRF Protection) ====================

model OAuthState {
  id              String   @id @default(uuid()) @db.Uuid
  organization_id String   @db.Uuid
  user_id         String   // Cognito user ID
  state           String   @unique // Random state parameter
  code_verifier   String   // PKCE code verifier
  redirect_uri    String?  // Optional: store redirect URI for validation
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  expires_at      DateTime @db.Timestamptz(6) // 10 minutes from creation
  used            Boolean  @default(false) // Mark as used after callback
  
  @@index([state])
  @@index([expires_at])
  @@index([organization_id])
  @@map("oauth_states")
}

// ==================== SECURITY & FINDINGS ====================

model Finding {
  id                String   @id @default(uuid()) @db.Uuid
  scan_id           String?  @db.Uuid  // Reference to security_scans.id
  organization_id   String   @db.Uuid
  aws_account_id    String?  @db.Uuid
  cloud_provider    CloudProvider? @default(AWS)
  azure_credential_id String? @db.Uuid
  event_id          String?
  event_name        String?
  event_time        DateTime? @db.Timestamptz(6)
  user_identity     Json?
  severity          String
  title             String
  description       String?
  resource_id       String?
  resource_type     String?
  region            String?
  details           Json?    @default("{}")
  ai_analysis       String?
  status            String   @default("open")
  source            String?  @db.VarChar
  resource_arn      String?
  scan_type         String?
  service           String?
  category          String?
  compliance        String[] @default([])
  remediation       String?
  risk_vector       String?
  evidence          Json?
  remediation_ticket_id String? @db.Uuid
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  updated_at        DateTime? @default(now()) @db.Timestamptz(6)
  
  // Finding fingerprinting & lifecycle
  fingerprint           String?   @db.VarChar(64)
  first_seen            DateTime? @db.Timestamptz(6)
  last_seen             DateTime? @db.Timestamptz(6)
  resolved_at           DateTime? @db.Timestamptz(6)
  occurrence_count      Int       @default(1)
  
  // False positive suppression
  suppressed            Boolean   @default(false)
  suppressed_by         String?   @db.VarChar(255)
  suppressed_at         DateTime? @db.Timestamptz(6)
  suppression_reason    String?
  suppression_expires_at DateTime? @db.Timestamptz(6)
  
  organization      Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  
  @@unique([organization_id, aws_account_id, fingerprint], name: "uq_finding_fingerprint")
  @@index([status])
  @@index([severity])
  @@index([event_time])
  @@index([organization_id])
  @@index([aws_account_id])
  @@index([cloud_provider])
  @@index([fingerprint])
  @@index([suppressed])
  @@index([first_seen])
  @@index([last_seen])
  @@map("findings")
}

model SecurityScan {
  id                String   @id @default(uuid()) @db.Uuid
  organization_id   String   @db.Uuid
  aws_account_id    String?  @db.Uuid  // Optional - null for Azure scans
  cloud_provider    CloudProvider @default(AWS)
  azure_credential  AzureCredential? @relation("AzureSecurityScans", fields: [azure_credential_id], references: [id])
  azure_credential_id String? @db.Uuid
  scan_type         String
  status            String   @default("pending")
  scan_config       Json?
  results           Json?
  findings_count    Int?
  critical_count    Int?
  high_count        Int?
  medium_count      Int?
  low_count         Int?
  started_at        DateTime @default(now()) @db.Timestamptz(6)
  completed_at      DateTime? @db.Timestamptz(6)
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  
  organization      Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  aws_credential    AwsCredential? @relation(fields: [aws_account_id], references: [id], onDelete: Cascade)  // Optional for Azure
  compliance_checks ComplianceCheck[]
  well_architected_scores WellArchitectedScore[]
  
  @@index([organization_id])
  @@index([status])
  @@index([cloud_provider])
  @@index([azure_credential_id])
  @@map("security_scans")
}

model ScanSchedule {
  id                  String        @id @default(uuid()) @db.Uuid
  organization_id     String        @db.Uuid
  aws_account_id      String?       @db.Uuid  // Optional - null for Azure scans
  cloud_provider      CloudProvider @default(AWS)
  azure_credential_id String?       @db.Uuid  // For Azure multi-cloud support
  scan_type           String
  schedule_type       String        // daily, weekly, monthly
  schedule_config     Json?
  is_active           Boolean       @default(true)
  last_run_at         DateTime?     @db.Timestamptz(6)
  next_run_at         DateTime?     @db.Timestamptz(6)
  created_at          DateTime      @default(now()) @db.Timestamptz(6)
  updated_at          DateTime      @updatedAt @db.Timestamptz(6)
  
  organization        Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  aws_credential      AwsCredential? @relation(fields: [aws_account_id], references: [id], onDelete: Cascade)
  azure_credential    AzureCredential? @relation("AzureScanSchedules", fields: [azure_credential_id], references: [id], onDelete: Cascade)
  
  @@index([organization_id])
  @@index([is_active])
  @@index([next_run_at])
  @@index([cloud_provider])
  @@index([azure_credential_id])
  @@map("scan_schedules")
}

model WellArchitectedScore {
  id                String   @id @default(uuid()) @db.Uuid
  organization_id   String   @db.Uuid
  scan_id           String   @db.Uuid
  pillar            String
  score             Int
  checks_passed     Int      @default(0)
  checks_failed     Int      @default(0)
  critical_issues   Int      @default(0)
  recommendations   Json?
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  
  scan              SecurityScan @relation(fields: [scan_id], references: [id], onDelete: Cascade)
  
  @@index([organization_id])
  @@index([scan_id])
  @@index([pillar])
  @@map("well_architected_scores")
}

model ComplianceCheck {
  id                  String   @id @default(uuid()) @db.Uuid
  scan_id             String   @db.Uuid
  framework           String
  control_id          String
  control_name        String
  status              String
  severity            String
  evidence            Json?
  remediation_steps   String?
  created_at          DateTime @default(now()) @db.Timestamptz(6)
  
  scan                SecurityScan @relation(fields: [scan_id], references: [id], onDelete: Cascade)
  
  @@index([scan_id])
  @@index([framework])
  @@index([status])
  @@map("compliance_checks")
}

model GuardDutyFinding {
  id                String   @id @default(uuid()) @db.Uuid
  organization_id   String   @db.Uuid
  aws_account_id    String   @db.Uuid
  finding_id        String
  finding_type      String
  severity          Float
  severity_label    String
  title             String
  description       String
  resource_type     String?
  resource_id       String?
  region            String
  service           String
  action            Json?
  evidence          Json?
  first_seen        String?
  last_seen         String?
  count             Int      @default(1)
  status            String   @default("active")
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  updated_at        DateTime @updatedAt @db.Timestamptz(6)
  
  aws_credential    AwsCredential @relation(fields: [aws_account_id], references: [id], onDelete: Cascade)
  
  @@unique([aws_account_id, finding_id])
  @@index([organization_id])
  @@index([status])
  @@index([severity_label])
  @@map("guardduty_findings")
}

model SecurityPosture {
  id                    String   @id @default(uuid()) @db.Uuid
  organization_id       String   @db.Uuid
  overall_score         Float
  critical_findings     Int
  high_findings         Int
  medium_findings       Int
  low_findings          Int
  compliance_score      Float?
  risk_level            String
  calculated_at         DateTime @default(now()) @db.Timestamptz(6)
  created_at            DateTime @default(now()) @db.Timestamptz(6)
  updated_at            DateTime @default(now()) @db.Timestamptz(6)
  
  @@index([organization_id])
  @@index([calculated_at])
  @@map("security_posture")
}

// ==================== BACKGROUND JOBS ====================

model BackgroundJob {
  id                String   @id @default(uuid()) @db.Uuid
  organization_id   String   @db.Uuid
  job_type          String
  status            String   @default("pending")
  payload           Json?
  result            Json?
  error             String?
  started_at        DateTime? @db.Timestamptz(6)
  completed_at      DateTime? @db.Timestamptz(6)
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  
  organization      Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  
  @@index([organization_id])
  @@index([status])
  @@index([job_type])
  @@map("background_jobs")
}

// ==================== KNOWLEDGE BASE ====================

model KnowledgeBaseArticle {
  id                String   @id @default(uuid()) @db.Uuid
  organization_id   String   @db.Uuid
  author_id         String   @db.Uuid
  title             String
  content           String
  category          String?
  tags              String[]
  status            String   @default("draft")
  approval_status   String   @default("draft")  // draft, pending_review, approved, rejected
  approved_by       String?  @db.Uuid
  approved_at       DateTime? @db.Timestamptz(6)
  rejection_reason  String?
  is_public         Boolean  @default(false)
  is_restricted     Boolean  @default(false)
  views             Int      @default(0)
  helpful_count     Int      @default(0)
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  updated_at        DateTime @updatedAt @db.Timestamptz(6)
  
  organization      Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  
  @@index([organization_id])
  @@index([status])
  @@index([approval_status])
  @@index([category])
  @@map("knowledge_base_articles")
}

model KnowledgeBaseFavorite {
  id          String   @id @default(uuid()) @db.Uuid
  article_id  String   @db.Uuid
  user_id     String   @db.Uuid
  created_at  DateTime @default(now()) @db.Timestamptz(6)
  
  @@unique([article_id, user_id])
  @@index([user_id])
  @@index([article_id])
  @@map("knowledge_base_favorites")
}

model KnowledgeBaseComment {
  id          String   @id @default(uuid()) @db.Uuid
  article_id  String   @db.Uuid
  user_id     String   @db.Uuid
  user_name   String?
  user_email  String?
  content     String
  parent_id   String?  @db.Uuid
  created_at  DateTime @default(now()) @db.Timestamptz(6)
  updated_at  DateTime @updatedAt @db.Timestamptz(6)
  
  @@index([article_id])
  @@index([user_id])
  @@index([parent_id])
  @@map("knowledge_base_comments")
}

// ==================== LICENSING ====================

model License {
  id                String   @id @default(uuid()) @db.Uuid
  organization_id   String   @db.Uuid
  customer_id       String?
  license_key       String   @unique
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  updated_at        DateTime @updatedAt @db.Timestamptz(6)
  plan_type         String?
  product_type      String?  // pilotone, enterprise, etc.
  max_accounts      Int?
  max_users         Int?     // total_seats from external API
  used_seats        Int?     @default(0)
  available_seats   Int?     @default(0)
  features          String[]
  valid_from        DateTime? @db.Timestamptz(6)
  valid_until       DateTime? @db.Timestamptz(6)
  is_active         Boolean  @default(true)
  is_trial          Boolean  @default(false)
  is_expired        Boolean  @default(false)
  days_remaining    Int?
  last_sync_at      DateTime? @db.Timestamptz(6)
  sync_error        String?
  
  organization      Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  seat_assignments  LicenseSeatAssignment[]
  
  @@index([organization_id])
  @@index([is_active])
  @@index([customer_id])
  @@map("licenses")
}

model LicenseSeatAssignment {
  id                String   @id @default(uuid()) @db.Uuid
  license_id        String   @db.Uuid
  user_id           String   @db.Uuid
  assigned_at       DateTime @default(now()) @db.Timestamptz(6)
  assigned_by       String?  @db.Uuid
  
  license           License @relation(fields: [license_id], references: [id], onDelete: Cascade)
  
  @@unique([license_id, user_id])
  @@index([license_id])
  @@index([user_id])
  @@map("license_seat_assignments")
}

model OrganizationLicenseConfig {
  id                String   @id @default(uuid()) @db.Uuid
  organization_id   String   @unique @db.Uuid
  customer_id       String   // External customer ID for license validation
  auto_sync         Boolean  @default(true)
  last_sync_at      DateTime? @db.Timestamptz(6)
  sync_status       String?  // success, error, pending
  sync_error        String?
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  updated_at        DateTime @updatedAt @db.Timestamptz(6)
  
  @@index([customer_id])
  @@map("organization_license_configs")
}

// ==================== WEBAUTHN ====================

model WebAuthnCredential {
  id                String   @id @default(uuid()) @db.Uuid
  user_id           String   // Cognito user ID (text, matches profiles.user_id)
  credential_id     String   @unique
  public_key        String
  counter           Int      @default(0)
  device_name       String?
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  last_used_at      DateTime? @db.Timestamptz(6)
  
  @@index([user_id])
  @@map("webauthn_credentials")
}

// ==================== COMMUNICATION LOGS ====================

model CommunicationLog {
  id                String   @id @default(uuid()) @db.Uuid
  organization_id   String   @db.Uuid
  channel           String
  recipient         String
  subject           String?
  message           String
  status            String
  metadata          Json?
  sent_at           DateTime @default(now()) @db.Timestamptz(6)
  
  @@index([organization_id])
  @@index([channel])
  @@index([status])
  @@map("communication_logs")
}

// ==================== COST MANAGEMENT ====================

model DailyCost {
  id              String   @id @default(uuid()) @db.Uuid
  organization_id String   @db.Uuid
  aws_account_id  String?  @db.Uuid  // Optional - null for Azure costs
  date            DateTime @db.Date
  service         String
  cost            Float    @default(0)
  region          String?
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  cloud_provider  CloudProvider? @default(AWS)
  azure_credential_id String? @db.Uuid
  usage           Float?   @default(0)
  currency        String?  @default("USD") @db.VarChar
  
  @@unique([organization_id, aws_account_id, date, service])
  @@index([organization_id])
  @@index([date])
  @@index([organization_id, date])
  @@index([aws_account_id])
  @@index([cloud_provider])
  @@index([azure_credential_id])
  @@map("daily_costs")
}

model WasteDetection {
  id                      String   @id @default(uuid()) @db.Uuid
  organization_id         String   @db.Uuid
  aws_account_id          String?  @db.Uuid  // UUID reference to aws_accounts.id
  resource_id             String
  resource_type           String
  resource_name           String?
  region                  String
  waste_type              String
  confidence              Float
  estimated_monthly_cost  Float
  estimated_savings       Float
  metrics                 Json?
  recommendation          String
  detected_at             DateTime @default(now()) @db.Timestamptz(6)
  
  @@index([organization_id])
  @@index([waste_type])
  @@index([detected_at])
  @@index([aws_account_id])
  @@map("waste_detections")
}

// ==================== DRIFT DETECTION ====================

model DriftDetection {
  id                String   @id @default(uuid()) @db.Uuid
  organization_id   String   @db.Uuid
  aws_account_id    String
  resource_id       String
  resource_type     String
  resource_name     String?
  drift_type        String
  detected_at       DateTime @default(now()) @db.Timestamptz(6)
  severity          String
  diff              Json?
  expected_state    Json?
  actual_state      Json?
  
  @@index([organization_id])
  @@index([drift_type])
  @@index([severity])
  @@index([detected_at])
  @@map("drift_detections")
}

model DriftDetectionHistory {
  id                      String   @id @default(uuid()) @db.Uuid
  organization_id         String   @db.Uuid
  total_drifts            Int
  created_count           Int
  modified_count          Int
  deleted_count           Int
  critical_count          Int
  high_count              Int
  execution_time_seconds  Float
  message                 String?
  created_at              DateTime @default(now()) @db.Timestamptz(6)
  
  @@index([organization_id])
  @@index([created_at])
  @@map("drift_detection_history")
}

model ResourceInventory {
  id                String   @id @default(uuid()) @db.Uuid
  organization_id   String   @db.Uuid
  aws_account_id    String?  // Optional - null for Azure resources
  cloud_provider    CloudProvider @default(AWS)
  azure_credential_id String? @db.Uuid
  resource_id       String
  resource_type     String
  resource_name     String?
  region            String
  metadata          Json?
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  updated_at        DateTime @updatedAt @db.Timestamptz(6)
  
  @@unique([aws_account_id, resource_id, region])
  @@index([organization_id])
  @@index([resource_type])
  @@index([cloud_provider])
  @@index([azure_credential_id])
  @@map("resource_inventory")
}

// ==================== COMPLIANCE ====================

model ComplianceViolation {
  id                String   @id @default(uuid()) @db.Uuid
  organization_id   String   @db.Uuid
  aws_account_id    String?  @db.Uuid  // UUID reference to aws_accounts.id
  framework         String
  control_id        String
  resource_id       String?
  resource_type     String?
  status            String   @default("OPEN")
  severity          String
  description       String?
  detected_at       DateTime @default(now()) @db.Timestamptz(6)
  resolved_at       DateTime? @db.Timestamptz(6)
  
  @@index([organization_id])
  @@index([framework])
  @@index([status])
  @@index([detected_at])
  @@index([aws_account_id])
  @@map("compliance_violations")
}

// ==================== ALERTS ====================

model Alert {
  id                String   @id @default(uuid()) @db.Uuid
  organization_id   String   @db.Uuid
  rule_id           String?  @db.Uuid
  severity          String
  title             String
  message           String
  metadata          Json?
  triggered_at      DateTime @default(now()) @db.Timestamptz(6)
  acknowledged_at   DateTime? @db.Timestamptz(6)
  resolved_at       DateTime? @db.Timestamptz(6)
  
  rule              AlertRule? @relation(fields: [rule_id], references: [id], onDelete: SetNull)
  
  @@index([organization_id])
  @@index([severity])
  @@index([triggered_at])
  @@map("alerts")
}

model AlertRule {
  id                      String   @id @default(uuid()) @db.Uuid
  organization_id         String   @db.Uuid
  name                    String
  description             String?
  rule_type               String?
  condition_type          String
  condition               Json?    @default("{}")
  condition_config        Json?
  threshold               Float?
  severity                String?  @default("medium")
  is_active               Boolean  @default(true)
  notification_channels   Json?
  created_at              DateTime? @default(now()) @db.Timestamptz(6)
  updated_at              DateTime? @default(now()) @db.Timestamptz(6)
  
  alerts                  Alert[]
  
  @@index([organization_id])
  @@index([is_active])
  @@map("alert_rules")
}

// ==================== MONITORING ====================

model MonitoredEndpoint {
  id                  String   @id @default(uuid()) @db.Uuid
  organization_id     String   @db.Uuid
  name                String
  url                 String
  timeout             Int      @default(5000)
  is_active           Boolean  @default(true)
  alert_on_failure    Boolean  @default(true)
  monitor_ssl         Boolean  @default(true)
  ssl_alert_days      Int      @default(30)
  ssl_expiry_date     DateTime? @db.Timestamptz(6)
  ssl_issuer          String?
  ssl_valid           Boolean?
  last_status         String?
  last_checked_at     DateTime? @db.Timestamptz(6)
  last_response_time  Int?
  created_at          DateTime @default(now()) @db.Timestamptz(6)
  
  check_history       EndpointCheckHistory[]
  
  @@index([organization_id])
  @@index([is_active])
  @@map("monitored_endpoints")
}

model EndpointCheckHistory {
  id            String   @id @default(uuid()) @db.Uuid
  endpoint_id   String   @db.Uuid
  status        String
  status_code   Int?
  response_time Int
  error         String?
  checked_at    DateTime @default(now()) @db.Timestamptz(6)
  
  endpoint      MonitoredEndpoint @relation(fields: [endpoint_id], references: [id], onDelete: Cascade)
  
  @@index([endpoint_id])
  @@index([checked_at])
  @@map("endpoint_check_history")
}

model IAMBehaviorAnomaly {
  id              String   @id @default(uuid()) @db.Uuid
  organization_id String   @db.Uuid
  aws_account_id  String?  @db.Uuid  // UUID reference to aws_accounts.id
  user_name       String
  anomaly_type    String
  severity        String
  description     String
  evidence        Json?
  detected_at     DateTime @default(now()) @db.Timestamptz(6)
  
  @@index([organization_id])
  @@index([severity])
  @@index([detected_at])
  @@index([aws_account_id])
  @@map("iam_behavior_anomalies")
}

// ==================== INTEGRATIONS ====================

model JiraIntegration {
  id              String   @id @default(uuid()) @db.Uuid
  organization_id String   @db.Uuid
  base_url        String
  email           String
  api_token       String
  project_key     String
  is_active       Boolean  @default(true)
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  
  @@index([organization_id])
  @@map("jira_integrations")
}

model JiraTicket {
  id              String   @id @default(uuid()) @db.Uuid
  organization_id String   @db.Uuid
  finding_id      String?  @db.Uuid
  jira_key        String
  jira_id         String
  title           String
  status          String
  url             String
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  updated_at      DateTime @updatedAt @db.Timestamptz(6)
  
  @@index([organization_id])
  @@index([finding_id])
  @@map("jira_tickets")
}

// ==================== EVENTS ====================
// SystemEvent moved to later section

// ==================== EXTERNAL IDS ====================

model ExternalId {
  id            String   @id @default(uuid()) @db.Uuid
  external_id   String   @unique
  used          Boolean  @default(false)
  used_by       String?
  created_at    DateTime @default(now()) @db.Timestamptz(6)
  
  @@index([used])
  @@index([created_at])
  @@map("external_ids")
}

// ==================== NOTIFICATION SETTINGS ====================

model NotificationSettings {
  id                    String   @id @default(uuid()) @db.Uuid
  userId                String   @unique @map("userid") @db.Uuid
  email_enabled         Boolean  @default(true)
  webhook_enabled       Boolean  @default(false)
  slack_enabled         Boolean  @default(false)
  security_alerts       Boolean  @default(true)
  cost_alerts           Boolean  @default(true)
  compliance_alerts     Boolean  @default(true)
  drift_alerts          Boolean  @default(true)
  daily_reports         Boolean  @default(false)
  weekly_reports        Boolean  @default(true)
  monthly_reports       Boolean  @default(true)
  on_demand_reports     Boolean  @default(true)
  webhook_url           String?
  slack_webhook_url     String?
  additional_emails     String[] @default([])
  created_at            DateTime @default(now()) @db.Timestamptz(6)
  updated_at            DateTime @updatedAt @db.Timestamptz(6)
  
  @@map("notification_settings")
}

// ==================== REPORTS ====================

model ReportExport {
  id                String   @id @default(uuid()) @db.Uuid
  organization_id   String   @db.Uuid
  report_type       String
  format            String
  status            String   @default("pending")
  file_url          String?
  file_size         Int?
  parameters        Json?
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  completed_at      DateTime? @db.Timestamptz(6)
  
  @@index([organization_id])
  @@index([status])
  @@map("report_exports")
}

model CloudTrailFetch {
  id                String   @id @default(uuid()) @db.Uuid
  organization_id   String   @db.Uuid
  aws_account_id    String
  region            String
  start_time        DateTime @db.Timestamptz(6)
  end_time          DateTime @db.Timestamptz(6)
  status            String   @default("pending")
  events_count      Int?
  error_message     String?
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  completed_at      DateTime? @db.Timestamptz(6)
  
  @@index([organization_id])
  @@index([status])
  @@map("cloudtrail_fetches")
}

model CloudTrailEvent {
  id                String   @id @default(uuid()) @db.Uuid
  organization_id   String   @db.Uuid
  aws_account_id    String   @db.Uuid
  event_id          String   // AWS CloudTrail Event ID
  event_name        String   // e.g., CreateUser, DeleteBucket
  event_source      String   // e.g., iam.amazonaws.com, s3.amazonaws.com
  event_time        DateTime @db.Timestamptz(6)
  aws_region        String
  source_ip_address String?
  user_agent        String?
  user_identity     Json     // Full user identity object from CloudTrail
  user_name         String?  // Extracted username for easy querying
  user_type         String?  // IAMUser, AssumedRole, Root, etc.
  user_arn          String?  // Full ARN of the user/role
  error_code        String?
  error_message     String?
  request_parameters Json?
  response_elements  Json?
  resources         Json?    // Array of affected resources
  risk_level        String   @default("low") // low, medium, high, critical
  risk_reasons      String[] // Array of reasons for the risk level
  security_explanation String? // Detailed explanation of why this is a security concern
  remediation_suggestion String? // Suggested actions to remediate or prevent
  event_category    String?  // Category: IAM, S3, EC2, KMS, etc.
  is_security_event Boolean  @default(false)
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  
  @@unique([organization_id, event_id])
  @@index([organization_id])
  @@index([aws_account_id])
  @@index([event_time])
  @@index([event_name])
  @@index([user_name])
  @@index([risk_level])
  @@index([is_security_event])
  @@map("cloudtrail_events")
}

model CloudTrailAnalysis {
  id                String   @id @default(uuid()) @db.Uuid
  organization_id   String   @db.Uuid
  aws_account_id    String   @db.Uuid
  status            String   @default("pending") // pending, running, completed, failed
  hours_back        Int      @default(24)
  max_results       Int      @default(5000)
  period_start      DateTime @db.Timestamptz(6) // Start of the analyzed period
  period_end        DateTime @db.Timestamptz(6) // End of the analyzed period
  events_processed  Int?
  events_saved      Int?
  critical_count    Int?
  high_count        Int?
  medium_count      Int?
  low_count         Int?
  error_message     String?
  started_at        DateTime? @db.Timestamptz(6)
  completed_at      DateTime? @db.Timestamptz(6)
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  
  @@index([organization_id])
  @@index([aws_account_id])
  @@index([status])
  @@index([period_start, period_end])
  @@map("cloudtrail_analyses")
}

// ==================== AUDIT LOGGING ====================

model AuditLog {
  id                String   @id @default(uuid()) @db.Uuid
  organization_id   String   @db.Uuid
  user_id           String?  @db.Uuid
  action            String
  resource_type     String?
  resource_id       String?
  details           Json?
  ip_address        String?
  user_agent        String?
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  
  @@index([organization_id])
  @@index([user_id])
  @@index([action])
  @@index([created_at])
  @@map("audit_logs")
}

// ==================== TV DISPLAY SYSTEM ====================

model TvDisplayToken {
  id                String   @id @default(uuid()) @db.Uuid
  token             String   @unique
  organization_id   String   @db.Uuid
  is_active         Boolean  @default(true)
  expires_at        DateTime @db.Timestamptz(6)
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  
  @@index([organization_id])
  @@index([token])
  @@map("tv_display_tokens")
}

model TvTokenUsage {
  id                String   @id @default(uuid()) @db.Uuid
  token_id          String   @db.Uuid
  used_at           DateTime @default(now()) @db.Timestamptz(6)
  ip_address        String?
  
  @@index([token_id])
  @@map("tv_token_usage")
}

model TvSession {
  id                String   @id @default(uuid()) @db.Uuid
  token_id          String   @db.Uuid
  session_data      Json?
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  updated_at        DateTime @updatedAt @db.Timestamptz(6)
  
  @@index([token_id])
  @@map("tv_sessions")
}

// ==================== SECURITY EVENTS ====================

model SecurityEvent {
  id                String   @id @default(uuid()) @db.Uuid
  organization_id   String   @db.Uuid
  event_type        String
  severity          String
  description       String
  metadata          Json?
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  
  @@index([organization_id])
  @@index([event_type])
  @@index([severity])
  @@map("security_events")
}

model SecurityFinding {
  id                String   @id @default(uuid()) @db.Uuid
  organization_id   String   @db.Uuid
  finding_type      String
  severity          String
  title             String
  description       String
  resource_id       String?
  status            String   @default("open")
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  
  @@index([organization_id])
  @@index([severity])
  @@index([status])
  @@map("security_findings")
}

// ==================== DASHBOARDS ====================

model Dashboard {
  id                String   @id @default(uuid()) @db.Uuid
  organization_id   String   @db.Uuid
  name              String
  config            Json?
  is_default        Boolean  @default(false)
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  updated_at        DateTime @updatedAt @db.Timestamptz(6)
  
  @@index([organization_id])
  @@map("dashboards")
}

// ==================== WEBAUTHN CHALLENGES ====================

model WebauthnChallenge {
  id                String   @id @default(uuid()) @db.Uuid
  user_id           String   // Cognito user ID (text, matches profiles.user_id)
  challenge         String
  expires_at        DateTime @db.Timestamptz(6)
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  
  @@index([user_id])
  @@index([challenge])
  @@map("webauthn_challenges")
}

// ==================== SESSIONS ====================

model Session {
  id                String   @id @default(uuid()) @db.Uuid
  user_id           String   @db.Uuid
  session_token     String   @unique
  expires_at        DateTime @db.Timestamptz(6)
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  
  @@index([user_id])
  @@index([session_token])
  @@map("sessions")
}

// ==================== SYSTEM EVENTS ====================

model SystemEvent {
  id                String   @id @default(uuid()) @db.Uuid
  organization_id   String   @db.Uuid
  event_type        String
  payload           Json?
  processed         Boolean  @default(false)
  processed_at      DateTime? @db.Timestamptz(6)
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  
  @@index([organization_id])
  @@index([processed])
  @@index([event_type])
  @@index([created_at])
  @@map("system_events")
}

// ==================== COST OPTIMIZATION ====================

model CostOptimization {
  id                     String   @id @default(uuid()) @db.Uuid
  organization_id        String   @db.Uuid
  aws_account_id         String?  // Optional - null for Azure optimizations
  azure_credential_id    String?  @db.Uuid  // For Azure multi-cloud support
  cloud_provider         CloudProvider @default(AWS)
  resource_type          String
  resource_id            String
  resource_name          String?
  optimization_type      String
  current_cost           Float?
  optimized_cost         Float?
  potential_savings      Float
  savings_percentage     Float?
  recommendation         String?
  details                String?
  priority               String?  // high, medium, low
  effort                 String?  // low, medium, high
  category               String?
  status                 String   @default("pending")
  remediation_ticket_id  String?  @db.Uuid  // Link to remediation ticket
  created_at             DateTime @default(now()) @db.Timestamptz(6)
  
  @@index([organization_id])
  @@index([aws_account_id])
  @@index([azure_credential_id])
  @@index([cloud_provider])
  @@index([optimization_type])
  @@index([priority])
  @@index([remediation_ticket_id])
  @@map("cost_optimizations")
}

// ==================== COPILOT INTERACTIONS ====================

model CopilotInteraction {
  id                String   @id @default(uuid()) @db.Uuid
  organization_id   String   @db.Uuid
  user_id           String?  @db.Uuid
  query             String
  response          String
  context           Json?
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  
  @@index([organization_id])
  @@index([user_id])
  @@map("copilot_interactions")
}

// ==================== COMPLIANCE SCANS ====================

model ComplianceScan {
  id                  String        @id @default(uuid()) @db.Uuid
  organization_id     String        @db.Uuid
  aws_account_id      String?       // Optional - null for Azure scans
  cloud_provider      CloudProvider @default(AWS)
  azure_credential_id String?       @db.Uuid  // For Azure multi-cloud support
  framework           String
  status              String        @default("pending")
  results             Json?
  created_at          DateTime      @default(now()) @db.Timestamptz(6)
  completed_at        DateTime?     @db.Timestamptz(6)
  
  @@index([organization_id])
  @@index([aws_account_id])
  @@index([cloud_provider])
  @@index([azure_credential_id])
  @@map("compliance_scans")
}


// ==================== RESOURCE MONITORING ====================

model MonitoredResource {
  id                  String        @id @default(uuid()) @db.Uuid
  organization_id     String        @db.Uuid
  aws_account_id      String?       @db.Uuid
  azure_credential_id String?       @db.Uuid
  cloud_provider      CloudProvider @default(AWS)
  resource_id         String
  resource_name       String
  resource_type       String
  region              String
  status              String        @default("unknown")
  metadata            Json?
  created_at          DateTime      @default(now()) @db.Timestamptz(6)
  updated_at          DateTime      @updatedAt @db.Timestamptz(6)
  
  @@unique([organization_id, aws_account_id, resource_id, resource_type])
  @@index([organization_id])
  @@index([aws_account_id])
  @@index([azure_credential_id])
  @@index([cloud_provider])
  @@index([resource_type])
  @@map("monitored_resources")
}

model ResourceMetric {
  id                  String        @id @default(uuid()) @db.Uuid
  organization_id     String        @db.Uuid
  aws_account_id      String?       @db.Uuid
  azure_credential_id String?       @db.Uuid
  cloud_provider      CloudProvider @default(AWS)
  resource_id         String
  resource_name       String?
  resource_type       String
  metric_name         String
  metric_value        Float
  metric_unit         String?
  timestamp           DateTime      @db.Timestamptz(6)
  created_at          DateTime      @default(now()) @db.Timestamptz(6)
  
  @@unique([organization_id, aws_account_id, resource_id, metric_name, timestamp])
  @@index([organization_id])
  @@index([aws_account_id])
  @@index([azure_credential_id])
  @@index([cloud_provider])
  @@index([resource_id])
  @@index([timestamp])
  @@map("resource_metrics")
}


// ==================== ML WASTE DETECTION ====================

model ResourceUtilizationML {
  id                        String   @id @default(uuid()) @db.Uuid
  organization_id           String   @db.Uuid
  aws_account_id            String?  @db.Uuid
  aws_account_number        String?  // 12-digit AWS account ID
  azure_credential_id       String?  @db.Uuid
  cloud_provider            String   @default("AWS") @db.VarChar(10)
  resource_id               String
  resource_arn              String?  // Full ARN - NEW in v3.0
  resource_name             String?
  resource_type             String
  resource_subtype          String?  // e.g., "gp3" for EBS, "t3.micro" for EC2
  region                    String
  
  // Current state
  current_size              String?
  current_monthly_cost      Float?
  current_hourly_cost       Float?   // NEW in v3.0
  
  // ML Analysis results
  recommendation_type       String?  // 'terminate', 'downsize', 'auto-scale', 'optimize', 'migrate'
  recommendation_priority   Int?     // 1-5 priority score - NEW in v3.0
  recommended_size          String?
  potential_monthly_savings Float?
  potential_annual_savings  Float?   // NEW in v3.0
  ml_confidence             Float?   // 0.0 to 1.0
  
  // Utilization patterns (JSON)
  utilization_patterns      Json?
  resource_metadata         Json?    // tags, creation date, etc. - NEW in v3.0
  dependencies              Json?    // linked resources - NEW in v3.0
  
  // Auto-scaling configuration
  auto_scaling_eligible     Boolean  @default(false)
  auto_scaling_config       Json?
  
  // Metadata
  implementation_complexity String?  // 'low', 'medium', 'high'
  implementation_steps      Json?    // step-by-step remediation - NEW in v3.0
  risk_assessment           String?  // 'low', 'medium', 'high' - NEW in v3.0
  analyzed_at               DateTime @default(now()) @db.Timestamptz(6)
  last_activity_at          DateTime? @db.Timestamptz(6) // NEW in v3.0
  days_since_activity       Int?     // NEW in v3.0
  
  created_at                DateTime @default(now()) @db.Timestamptz(6)
  updated_at                DateTime @updatedAt @db.Timestamptz(6)
  
  @@unique([organization_id, aws_account_id, resource_arn])
  @@index([organization_id])
  @@index([aws_account_id])
  @@index([azure_credential_id])
  @@index([cloud_provider])
  @@index([resource_arn])
  @@index([recommendation_type])
  @@index([recommendation_priority])
  @@index([potential_monthly_savings])
  @@map("resource_utilization_ml")
}

model MLAnalysisHistory {
  id                      String   @id @default(uuid()) @db.Uuid
  organization_id         String   @db.Uuid
  aws_account_id          String?  @db.Uuid
  aws_account_number      String?
  azure_credential_id     String?  @db.Uuid
  cloud_provider          String   @default("AWS") @db.VarChar(10)
  
  // Scan metadata
  scan_type               String   @default("ml-waste-detection") // 'ml-waste-detection', 'cost-optimization', etc.
  status                  String   @default("running") // 'running', 'completed', 'failed'
  
  // Results summary
  total_resources_analyzed Int     @default(0)
  total_recommendations    Int     @default(0)
  total_monthly_savings    Float   @default(0)
  total_annual_savings     Float   @default(0)
  
  // Breakdown by type
  terminate_count          Int     @default(0)
  downsize_count           Int     @default(0)
  autoscale_count          Int     @default(0)
  optimize_count           Int     @default(0)
  migrate_count            Int     @default(0)
  
  // Breakdown by resource type (JSON)
  by_resource_type         Json?
  
  // Execution details
  regions_scanned          Json?   // Array of regions
  analysis_depth           String? // 'standard', 'deep'
  execution_time_seconds   Float?
  error_message            String?
  
  // Timestamps
  started_at               DateTime @default(now()) @db.Timestamptz(6)
  completed_at             DateTime? @db.Timestamptz(6)
  created_at               DateTime @default(now()) @db.Timestamptz(6)
  
  @@index([organization_id])
  @@index([aws_account_id])
  @@index([azure_credential_id])
  @@index([cloud_provider])
  @@index([scan_type])
  @@index([status])
  @@index([started_at])
  @@map("ml_analysis_history")
}


// ==================== MFA FACTORS ====================

model MfaFactor {
  id                String   @id @default(uuid()) @db.Uuid
  user_id           String   // Cognito user ID (text, not uuid)
  factor_type       String   // 'totp', 'sms', 'email'
  secret            String
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  friendly_name     String?  @db.VarChar
  status            String?  @db.VarChar // 'pending', 'verified', 'disabled'
  is_active         Boolean  @default(true)
  verified_at       DateTime? @db.Timestamptz(6)
  deactivated_at    DateTime? @db.Timestamptz(6)
  last_used_at      DateTime? @db.Timestamptz(6)
  
  @@index([user_id])
  @@index([is_active])
  @@map("mfa_factors")
}

// ==================== KB ARTICLE VIEWS ====================

model KbArticleView {
  id                String   @id @default(uuid()) @db.Uuid
  article_id        String   @db.Uuid
  user_id           String?  @db.Uuid
  organization_id   String   @db.Uuid
  session_id        String?
  source            String?  // 'direct', 'search', 'link'
  search_query      String?
  action            String   @default("view") // 'view', 'helpful', 'not_helpful'
  metadata          Json?
  viewed_at         DateTime @default(now()) @db.Timestamptz(6)
  
  @@index([article_id])
  @@index([user_id])
  @@index([organization_id])
  @@index([viewed_at])
  @@map("kb_article_views")
}

// ==================== SECURITY ALERTS ====================

model SecurityAlert {
  id                String   @id @default(uuid()) @db.Uuid
  organization_id   String   @db.Uuid
  aws_account_id    String?  @db.Uuid
  alert_type        String
  severity          String
  title             String
  description       String
  resource_id       String?
  resource_type     String?
  is_resolved       Boolean  @default(false)
  resolved_at       DateTime? @db.Timestamptz(6)
  resolved_by       String?  @db.Uuid
  metadata          Json?
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  
  @@index([organization_id])
  @@index([is_resolved])
  @@index([severity])
  @@map("security_alerts")
}

// ==================== AWS RESOURCES ====================

model AwsResource {
  id                String   @id @default(uuid()) @db.Uuid
  organization_id   String   @db.Uuid
  aws_account_id    String   @db.Uuid
  resource_id       String
  resource_arn      String?
  resource_name     String?
  resource_type     String
  region            String
  status            String?
  tags              Json?
  metadata          Json?
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  updated_at        DateTime @updatedAt @db.Timestamptz(6)
  
  @@unique([organization_id, aws_account_id, resource_id, resource_type])
  @@index([organization_id])
  @@index([aws_account_id])
  @@index([resource_type])
  @@map("aws_resources")
}


// ==================== EDGE SERVICES (CloudFront, WAF, Load Balancers) ====================

model EdgeService {
  id                    String   @id @default(uuid()) @db.Uuid
  organization_id       String   @db.Uuid
  cloud_provider        CloudProvider @default(AWS)
  aws_account_id        String?  @db.Uuid  // For AWS services (CloudFront, WAF, ALB/NLB)
  azure_credential_id   String?  @db.Uuid  // For Azure services (Front Door, WAF, App Gateway, NAT Gateway)
  service_type          String   // AWS: 'cloudfront', 'waf', 'load_balancer' | Azure: 'front_door', 'azure_waf', 'application_gateway', 'load_balancer', 'nat_gateway', 'api_management'
  service_name          String
  service_id            String   // CloudFront Distribution ID, WAF Web ACL ID, ALB/NLB ARN, or Azure resource ID
  status                String   @default("active") // 'active', 'inactive', 'error'
  region                String   @default("global")
  domain_name           String?  // CloudFront domain, ALB DNS name, or Azure Front Door endpoint
  origin_domain         String?  // Origin domain for CloudFront/Front Door
  requests_per_minute   Float    @default(0)
  cache_hit_rate        Float    @default(0)
  error_rate            Float    @default(0)
  blocked_requests      Int      @default(0)
  metadata              Json?    // Additional service-specific data
  last_updated          DateTime @default(now()) @db.Timestamptz(6)
  created_at            DateTime @default(now()) @db.Timestamptz(6)
  
  metrics               EdgeMetric[]
  
  @@unique([organization_id, service_id])
  @@index([organization_id])
  @@index([cloud_provider])
  @@index([aws_account_id])
  @@index([azure_credential_id])
  @@index([service_type])
  @@map("edge_services")
}

model EdgeMetric {
  id                    String   @id @default(uuid()) @db.Uuid
  organization_id       String   @db.Uuid
  cloud_provider        CloudProvider @default(AWS)
  aws_account_id        String?  @db.Uuid
  azure_credential_id   String?  @db.Uuid
  service_id            String   @db.Uuid
  timestamp             DateTime @db.Timestamptz(6)
  requests              Int      @default(0)
  cache_hits            Int      @default(0)
  cache_misses          Int      @default(0)
  blocked_requests      Int      @default(0)
  response_time         Float    @default(0) // Average response time in ms
  bandwidth_gb          Float    @default(0)
  error_4xx             Int      @default(0)
  error_5xx             Int      @default(0)
  created_at            DateTime @default(now()) @db.Timestamptz(6)
  
  edge_service          EdgeService @relation(fields: [service_id], references: [id], onDelete: Cascade)
  
  @@unique([service_id, timestamp])
  @@index([organization_id])
  @@index([cloud_provider])
  @@index([aws_account_id])
  @@index([azure_credential_id])
  @@index([service_id])
  @@index([timestamp])
  @@map("edge_metrics")
}


// ==================== REMEDIATION TICKETS ====================

model RemediationTicket {
  id                      String   @id @default(uuid()) @db.Uuid
  organization_id         String   @db.Uuid
  aws_account_id          String?  @db.Uuid
  azure_credential_id     String?  @db.Uuid  // For Azure multi-cloud support
  title                   String
  description             String?
  severity                String   @default("medium") // low, medium, high, critical
  priority                String   @default("medium") // low, medium, high, urgent
  status                  String   @default("open") // open, in_progress, pending_review, blocked, resolved, closed, cancelled, reopened
  category                String   @default("security") // security, compliance, cost_optimization, performance, configuration
  created_by              String
  assigned_to             String?  @db.Uuid
  finding_ids             String[] // Array of finding IDs
  metadata                Json?    // Additional data like findings count, services, etc.
  estimated_effort        String?  // low, medium, high
  estimated_effort_hours  Int      @default(0)
  due_date                DateTime? @db.Timestamptz(6)
  business_impact         String?
  affected_resources      String[] @default([])
  automation_available    Boolean  @default(false)
  resolution_notes        String?
  resolved_at             DateTime? @db.Timestamptz(6)
  created_at              DateTime @default(now()) @db.Timestamptz(6)
  updated_at              DateTime @updatedAt @db.Timestamptz(6)
  
  // SLA Fields
  sla_policy_id           String?  @db.Uuid
  sla_due_at              DateTime? @db.Timestamptz(6)  // Prazo do SLA baseado na política
  sla_breached            Boolean  @default(false)
  sla_breach_notified     Boolean  @default(false)
  first_response_at       DateTime? @db.Timestamptz(6)
  time_to_first_response  Int?     // minutos
  time_to_resolution      Int?     // minutos
  escalation_level        Int      @default(0)
  escalated_at            DateTime? @db.Timestamptz(6)
  
  organization            Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  sla_policy              SlaPolicy? @relation(fields: [sla_policy_id], references: [id])
  
  // Relations
  history                 TicketHistory[]
  comments                TicketComment[]
  checklist_items         TicketChecklistItem[]
  source_relations        TicketRelation[] @relation("SourceTicket")
  target_relations        TicketRelation[] @relation("TargetTicket")
  attachments             TicketAttachment[]
  
  @@index([organization_id])
  @@index([aws_account_id])
  @@index([azure_credential_id])
  @@index([status])
  @@index([priority])
  @@index([severity])
  @@index([created_by])
  @@index([assigned_to])
  @@index([sla_due_at])
  @@index([sla_breached])
  @@index([sla_policy_id])
  @@map("remediation_tickets")
}

// ==================== TICKET HISTORY (Audit Trail) ====================

model TicketHistory {
  id              String   @id @default(uuid()) @db.Uuid
  ticket_id       String   @db.Uuid
  user_id         String   @db.Uuid
  user_name       String?
  user_email      String?
  action          String   // created, status_changed, assigned, commented, priority_changed, severity_changed, sla_breached, escalated, resolved, reopened, checklist_updated
  field_changed   String?  // status, priority, assigned_to, severity, etc.
  old_value       String?
  new_value       String?
  comment         String?  // Optional comment with the action
  metadata        Json?    // Additional context
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  
  ticket          RemediationTicket @relation(fields: [ticket_id], references: [id], onDelete: Cascade)
  
  @@index([ticket_id])
  @@index([user_id])
  @@index([action])
  @@index([created_at])
  @@map("ticket_history")
}

// ==================== TICKET COMMENTS ====================

model TicketComment {
  id              String   @id @default(uuid()) @db.Uuid
  ticket_id       String   @db.Uuid
  user_id         String   @db.Uuid
  user_name       String?
  user_email      String?
  content         String
  is_internal     Boolean  @default(false)  // Internal comments not visible to all users
  is_resolution   Boolean  @default(false)  // Marked as resolution comment
  attachments     String[] @default([])     // Array of attachment URLs
  parent_id       String?  @db.Uuid         // For threaded comments
  mentions        String[] @default([])     // Array of mentioned user IDs
  edited          Boolean  @default(false)
  edited_at       DateTime? @db.Timestamptz(6)
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  updated_at      DateTime @updatedAt @db.Timestamptz(6)
  
  ticket          RemediationTicket @relation(fields: [ticket_id], references: [id], onDelete: Cascade)
  
  @@index([ticket_id])
  @@index([user_id])
  @@index([parent_id])
  @@index([created_at])
  @@map("ticket_comments")
}

// ==================== SLA POLICIES ====================

model SlaPolicy {
  id                        String   @id @default(uuid()) @db.Uuid
  organization_id           String   @db.Uuid
  name                      String
  description               String?
  severity                  String   // critical, high, medium, low
  category                  String?  // Optional: apply only to specific category
  response_time_minutes     Int      // Time to first response
  resolution_time_minutes   Int      // Time to resolution
  escalation_enabled        Boolean  @default(true)
  escalation_after_minutes  Int?     // Escalate after X minutes without response
  escalation_to             String?  @db.Uuid  // User to escalate to
  notify_on_breach          Boolean  @default(true)
  notify_before_breach_minutes Int?  // Notify X minutes before breach
  is_active                 Boolean  @default(true)
  created_at                DateTime @default(now()) @db.Timestamptz(6)
  updated_at                DateTime @updatedAt @db.Timestamptz(6)
  
  tickets                   RemediationTicket[]
  
  @@unique([organization_id, severity, category])
  @@index([organization_id])
  @@index([severity])
  @@index([is_active])
  @@map("sla_policies")
}

// ==================== TICKET CHECKLIST ====================

model TicketChecklistItem {
  id              String   @id @default(uuid()) @db.Uuid
  ticket_id       String   @db.Uuid
  title           String
  description     String?
  is_completed    Boolean  @default(false)
  completed_by    String?  @db.Uuid
  completed_by_name String?
  completed_at    DateTime? @db.Timestamptz(6)
  order_index     Int      @default(0)
  is_required     Boolean  @default(false)  // Blocks resolution if not completed
  due_date        DateTime? @db.Timestamptz(6)
  created_by      String?  @db.Uuid
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  updated_at      DateTime @updatedAt @db.Timestamptz(6)
  
  ticket          RemediationTicket @relation(fields: [ticket_id], references: [id], onDelete: Cascade)
  
  @@index([ticket_id])
  @@index([is_completed])
  @@index([order_index])
  @@map("ticket_checklist_items")
}

// ==================== TICKET RELATIONS ====================

model TicketRelation {
  id                String   @id @default(uuid()) @db.Uuid
  source_ticket_id  String   @db.Uuid
  target_ticket_id  String   @db.Uuid
  relation_type     String   // blocks, blocked_by, duplicates, duplicate_of, related_to, parent_of, child_of, caused_by, causes
  created_by        String   @db.Uuid
  created_by_name   String?
  notes             String?
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  
  source_ticket     RemediationTicket @relation("SourceTicket", fields: [source_ticket_id], references: [id], onDelete: Cascade)
  target_ticket     RemediationTicket @relation("TargetTicket", fields: [target_ticket_id], references: [id], onDelete: Cascade)
  
  @@unique([source_ticket_id, target_ticket_id, relation_type])
  @@index([source_ticket_id])
  @@index([target_ticket_id])
  @@index([relation_type])
  @@map("ticket_relations")
}

// ==================== TICKET ATTACHMENTS ====================

model TicketAttachment {
  id              String   @id @default(uuid()) @db.Uuid
  ticket_id       String   @db.Uuid
  comment_id      String?  @db.Uuid  // Optional: attachment can be linked to a comment
  file_name       String
  original_name   String
  file_size       Int      // bytes
  mime_type       String
  s3_key          String   // S3 object key
  s3_bucket       String   // S3 bucket name
  uploaded_by     String   @db.Uuid
  uploaded_by_name String?
  description     String?
  is_deleted      Boolean  @default(false)  // Soft delete
  deleted_at      DateTime? @db.Timestamptz(6)
  deleted_by      String?  @db.Uuid
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  
  ticket          RemediationTicket @relation(fields: [ticket_id], references: [id], onDelete: Cascade)
  
  @@index([ticket_id])
  @@index([comment_id])
  @@index([uploaded_by])
  @@index([is_deleted])
  @@map("ticket_attachments")
}

// ==================== USER ROLES ====================

model UserRole {
  id                String   @id @default(uuid()) @db.Uuid
  user_id           String   @db.Uuid
  organization_id   String   @db.Uuid
  role              String   // 'super_admin', 'org_admin', 'org_user', 'viewer'
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  updated_at        DateTime @updatedAt @db.Timestamptz(6)
  
  @@unique([user_id, organization_id, role])
  @@index([user_id])
  @@index([organization_id])
  @@index([role])
  @@map("user_roles")
}

// ==================== RESERVED INSTANCES & SAVINGS PLANS ====================

model ReservedInstance {
  id                          String   @id @default(uuid()) @db.Uuid
  organization_id             String   @db.Uuid
  aws_account_id              String   @db.Uuid
  aws_account_number          String?  // 12-digit AWS account ID
  
  // RI Identification
  reserved_instance_id        String   @unique
  instance_type               String   // e.g., t3.medium, m5.large
  product_description         String   // Linux/UNIX, Windows, etc.
  availability_zone           String?
  region                      String
  
  // RI Details
  instance_count              Int
  state                       String   // active, retired, payment-pending
  offering_class              String   // standard, convertible
  offering_type               String   // All Upfront, Partial Upfront, No Upfront
  
  // Pricing
  fixed_price                 Float?
  usage_price                 Float?
  recurring_charges           Json?    // Array of recurring charge details
  
  // Time
  start_date                  DateTime @db.Timestamptz(6)
  end_date                    DateTime @db.Timestamptz(6)
  duration_seconds            Int
  
  // Utilization & Coverage
  utilization_percentage      Float?   // 0-100
  hours_used                  Float?
  hours_unused                Float?
  net_savings                 Float?
  on_demand_cost_equivalent   Float?
  
  // Metadata
  scope                       String?  // Availability Zone, Region
  tags                        Json?
  
  // Analysis timestamps
  last_analyzed_at            DateTime? @db.Timestamptz(6)
  created_at                  DateTime @default(now()) @db.Timestamptz(6)
  updated_at                  DateTime @updatedAt @db.Timestamptz(6)
  
  @@index([organization_id])
  @@index([aws_account_id])
  @@index([state])
  @@index([end_date])
  @@index([utilization_percentage])
  @@map("reserved_instances")
}

model SavingsPlan {
  id                          String   @id @default(uuid()) @db.Uuid
  organization_id             String   @db.Uuid
  aws_account_id              String   @db.Uuid
  aws_account_number          String?
  
  // Savings Plan Identification
  savings_plan_id             String   @unique
  savings_plan_arn            String?
  savings_plan_type           String   // Compute, EC2 Instance, SageMaker
  payment_option              String   // All Upfront, Partial Upfront, No Upfront
  
  // Commitment
  commitment                  Float    // Hourly commitment in USD
  currency                    String   @default("USD")
  
  // Coverage
  region                      String?
  instance_family             String?  // For EC2 Instance Savings Plans
  
  // Status
  state                       String   // active, retired, queued, pending-return
  
  // Time
  start_date                  DateTime @db.Timestamptz(6)
  end_date                    DateTime @db.Timestamptz(6)
  
  // Utilization & Savings
  utilization_percentage      Float?   // 0-100
  coverage_percentage         Float?   // 0-100
  total_commitment_to_date    Float?
  used_commitment             Float?
  unused_commitment           Float?
  net_savings                 Float?
  on_demand_cost_equivalent   Float?
  
  // Metadata
  tags                        Json?
  offering_id                 String?
  
  // Analysis timestamps
  last_analyzed_at            DateTime? @db.Timestamptz(6)
  created_at                  DateTime @default(now()) @db.Timestamptz(6)
  updated_at                  DateTime @updatedAt @db.Timestamptz(6)
  
  @@index([organization_id])
  @@index([aws_account_id])
  @@index([state])
  @@index([end_date])
  @@index([utilization_percentage])
  @@index([savings_plan_type])
  @@map("savings_plans")
}

model RiSpRecommendation {
  id                          String   @id @default(uuid()) @db.Uuid
  organization_id             String   @db.Uuid
  aws_account_id              String   @db.Uuid
  
  // Recommendation Type
  recommendation_type         String   // 'reserved_instance', 'savings_plan'
  service                     String   // EC2, RDS, ElastiCache, etc.
  
  // For RIs
  instance_type               String?
  region                      String?
  platform                    String?  // Linux/UNIX, Windows
  tenancy                     String?  // default, dedicated
  offering_class              String?  // standard, convertible
  
  // For Savings Plans
  savings_plan_type           String?  // Compute, EC2 Instance
  payment_option              String?
  term_years                  Int?     // 1 or 3
  
  // Financial Analysis
  estimated_monthly_savings   Float
  estimated_annual_savings    Float
  upfront_cost                Float?
  estimated_monthly_cost      Float?
  estimated_roi_months        Int?     // Months to break even
  
  // Usage Analysis
  lookback_period_days        Int      @default(30)
  average_usage_hours         Float?
  normalized_units_per_hour   Float?
  recommended_units           Int?
  
  // Confidence & Priority
  confidence_level            String   // high, medium, low
  priority                    Int      // 1-5
  
  // Implementation
  implementation_effort       String   // low, medium, high
  implementation_steps        Json?
  potential_risks             String[]
  
  // Metadata
  recommendation_details      Json?
  generated_at                DateTime @default(now()) @db.Timestamptz(6)
  expires_at                  DateTime? @db.Timestamptz(6)
  status                      String   @default("active") // active, implemented, dismissed, expired
  
  created_at                  DateTime @default(now()) @db.Timestamptz(6)
  updated_at                  DateTime @updatedAt @db.Timestamptz(6)
  
  @@index([organization_id])
  @@index([aws_account_id])
  @@index([recommendation_type])
  @@index([status])
  @@index([estimated_annual_savings])
  @@index([priority])
  @@map("ri_sp_recommendations")
}

model RiSpUtilizationHistory {
  id                          String   @id @default(uuid()) @db.Uuid
  organization_id             String   @db.Uuid
  aws_account_id              String   @db.Uuid
  
  // Reference
  resource_type               String   // 'reserved_instance', 'savings_plan'
  resource_id                 String   // RI ID or Savings Plan ID
  
  // Time period
  period_start                DateTime @db.Timestamptz(6)
  period_end                  DateTime @db.Timestamptz(6)
  
  // Utilization metrics
  utilization_percentage      Float
  coverage_percentage         Float?
  hours_used                  Float?
  hours_unused                Float?
  
  // Cost metrics
  net_savings                 Float?
  on_demand_cost_equivalent   Float?
  amortized_upfront_fee       Float?
  amortized_recurring_fee     Float?
  total_actual_cost           Float?
  
  // Metadata
  instance_count              Int?
  created_at                  DateTime @default(now()) @db.Timestamptz(6)
  
  @@unique([organization_id, resource_type, resource_id, period_start])
  @@index([organization_id])
  @@index([aws_account_id])
  @@index([resource_type, resource_id])
  @@index([period_start])
  @@map("ri_sp_utilization_history")
}

// ==================== PREDICTIVE INCIDENTS (ML) ====================

model PredictiveIncident {
  id                      String   @id @default(uuid()) @db.Uuid
  organization_id         String   @db.Uuid
  aws_account_id          String?  @db.Uuid
  
  // Resource info
  resource_id             String?
  resource_name           String?
  resource_type           String?
  region                  String?
  
  // Prediction details
  incident_type           String   // security_incident, configuration_drift, cost_spike, availability_issue
  severity                String   // critical, high, medium, low
  probability             Int      // 0-100
  confidence_score        Int      // 0-100
  timeframe               String?  // e.g., "24-48 hours", "1-3 days"
  time_to_incident_hours  Int?     // Estimated hours until incident
  
  // Analysis
  description             String
  recommendation          String?
  recommended_actions     String?
  contributing_factors    Json?    // Array of {factor, value, weight}
  indicators              Json?    // Raw indicator data
  
  // Status
  status                  String   @default("active") // active, mitigated, resolved, false_positive
  mitigated_at            DateTime? @db.Timestamptz(6)
  resolved_at             DateTime? @db.Timestamptz(6)
  
  created_at              DateTime @default(now()) @db.Timestamptz(6)
  updated_at              DateTime @updatedAt @db.Timestamptz(6)
  
  @@index([organization_id])
  @@index([aws_account_id])
  @@index([severity])
  @@index([incident_type])
  @@index([status])
  @@index([probability])
  @@index([created_at])
  @@map("predictive_incidents")
}

model PredictiveIncidentsHistory {
  id                      String   @id @default(uuid()) @db.Uuid
  organization_id         String   @db.Uuid
  aws_account_id          String?  @db.Uuid
  
  // Scan results
  total_predictions       Int      @default(0)
  critical_count          Int      @default(0)
  high_risk_count         Int      @default(0)
  medium_count            Int      @default(0)
  low_count               Int      @default(0)
  
  // Execution info
  execution_time_seconds  Float?
  message                 String?
  
  // Analyzed data summary
  alerts_analyzed         Int?
  findings_analyzed       Int?
  drifts_analyzed         Int?
  cost_points_analyzed    Int?
  
  scan_date               DateTime @default(now()) @db.Timestamptz(6)
  created_at              DateTime @default(now()) @db.Timestamptz(6)
  
  @@index([organization_id])
  @@index([aws_account_id])
  @@index([scan_date])
  @@map("predictive_incidents_history")
}


// ==================== WAF REAL-TIME MONITORING ====================

model WafMonitoringConfig {
  id                    String   @id @default(uuid()) @db.Uuid
  organization_id       String   @db.Uuid
  aws_account_id        String   @db.Uuid  // Referência para aws_credentials
  web_acl_arn           String
  web_acl_name          String
  log_group_name        String
  subscription_filter   String?
  filter_mode           String   @default("block_only") // block_only, all_requests, hybrid
  is_active             Boolean  @default(true)
  last_event_at         DateTime? @db.Timestamptz(6)
  events_today          Int      @default(0)
  blocked_today         Int      @default(0)
  created_at            DateTime @default(now()) @db.Timestamptz(6)
  updated_at            DateTime @updatedAt @db.Timestamptz(6)
  
  @@unique([organization_id, web_acl_arn])
  @@index([organization_id])
  @@index([aws_account_id])
  @@map("waf_monitoring_configs")
}

model WafEvent {
  id                String   @id @default(uuid()) @db.Uuid
  organization_id   String   @db.Uuid
  aws_account_id    String   @db.Uuid
  timestamp         DateTime @db.Timestamptz(6)
  action            String   // ALLOW, BLOCK, COUNT
  source_ip         String
  country           String?
  region            String?
  user_agent        String?
  uri               String
  http_method       String
  rule_matched      String?
  threat_type       String?
  severity          String   @default("low")
  is_campaign       Boolean  @default(false)
  campaign_id       String?  @db.Uuid
  raw_log           Json
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  
  @@index([organization_id])
  @@index([timestamp])
  @@index([source_ip])
  @@index([threat_type])
  @@index([severity])
  @@index([organization_id, timestamp])
  @@index([organization_id, action])
  @@index([organization_id, timestamp, action])
  @@map("waf_events")
}

model WafAttackCampaign {
  id                String   @id @default(uuid()) @db.Uuid
  organization_id   String   @db.Uuid
  source_ip         String
  start_time        DateTime @db.Timestamptz(6)
  end_time          DateTime? @db.Timestamptz(6)
  event_count       Int      @default(1)
  attack_types      String[]
  severity          String
  status            String   @default("active") // active, resolved, blocked
  auto_blocked      Boolean  @default(false)
  blocked_at        DateTime? @db.Timestamptz(6)
  unblocked_at      DateTime? @db.Timestamptz(6)
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  
  @@index([organization_id])
  @@index([source_ip])
  @@index([status])
  @@map("waf_attack_campaigns")
}

model WafBlockedIp {
  id                String   @id @default(uuid()) @db.Uuid
  organization_id   String   @db.Uuid
  ip_address        String
  reason            String
  blocked_by        String   // auto, manual
  blocked_at        DateTime @default(now()) @db.Timestamptz(6)
  expires_at        DateTime @db.Timestamptz(6)
  waf_ip_set_id     String?  // AWS WAF IP Set ID
  is_active         Boolean  @default(true)
  
  @@unique([organization_id, ip_address])
  @@index([organization_id])
  @@index([expires_at])
  @@map("waf_blocked_ips")
}

model WafAlertConfig {
  id                    String   @id @default(uuid()) @db.Uuid
  organization_id       String   @unique @db.Uuid
  sns_enabled           Boolean  @default(true)
  sns_topic_arn         String?
  slack_enabled         Boolean  @default(false)
  slack_webhook_url     String?
  in_app_enabled        Boolean  @default(true)
  campaign_threshold    Int      @default(10)
  campaign_window_mins  Int      @default(5)
  auto_block_enabled    Boolean  @default(false)
  auto_block_threshold  Int      @default(50)
  block_duration_hours  Int      @default(24)
  created_at            DateTime @default(now()) @db.Timestamptz(6)
  updated_at            DateTime @updatedAt @db.Timestamptz(6)
  
  @@map("waf_alert_configs")
}

model WafAiAnalysis {
  id                String   @id @default(uuid()) @db.Uuid
  organization_id   String   @db.Uuid
  analysis          String   @db.Text  // AI-generated analysis markdown
  context           Json     // Metrics, threat types, top attackers, etc.
  risk_level        String?  // low, medium, high, critical
  ai_model          String?  // Model used (e.g., claude-3.5-sonnet)
  is_fallback       Boolean  @default(false) // True if AI was unavailable
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  
  @@index([organization_id])
  @@index([organization_id, created_at(sort: Desc)])
  @@map("waf_ai_analyses")
}


// ==================== AZURE ACTIVITY EVENTS ====================
// Equivalent to CloudTrail for Azure

model AzureActivityEvent {
  id                  String   @id @default(uuid()) @db.Uuid
  organization_id     String   @db.Uuid
  azure_credential_id String   @db.Uuid
  event_id            String
  event_name          String
  event_time          DateTime @db.Timestamptz(6)
  caller              String?
  caller_type         String?
  source_ip           String?
  correlation_id      String?
  operation_name      String?
  resource_id         String?
  resource_type       String?
  resource_group      String?
  status              String?
  risk_level          String   @default("low")
  risk_reasons        String[]
  raw_event           Json?
  created_at          DateTime @default(now()) @db.Timestamptz(6)
  
  azure_credential    AzureCredential @relation(fields: [azure_credential_id], references: [id], onDelete: Cascade)
  
  @@unique([organization_id, event_id])
  @@index([organization_id])
  @@index([azure_credential_id])
  @@index([event_time])
  @@index([risk_level])
  @@map("azure_activity_events")
}

// ==================== AZURE DEFENDER FINDINGS ====================
// Equivalent to AWS GuardDuty

model AzureDefenderFinding {
  id                  String   @id @default(uuid()) @db.Uuid
  organization_id     String   @db.Uuid
  azure_credential_id String   @db.Uuid
  alert_id            String
  alert_type          String
  severity            String
  title               String
  description         String?
  resource_id         String?
  resource_type       String?
  resource_group      String?
  subscription_id     String?
  status              String   @default("active")
  intent              String?
  compromised_entity  String?
  remediation_steps   String[]
  extended_properties Json?
  start_time          DateTime? @db.Timestamptz(6)
  end_time            DateTime? @db.Timestamptz(6)
  processing_end_time DateTime? @db.Timestamptz(6)
  created_at          DateTime @default(now()) @db.Timestamptz(6)
  updated_at          DateTime @updatedAt @db.Timestamptz(6)
  
  azure_credential    AzureCredential @relation(fields: [azure_credential_id], references: [id], onDelete: Cascade)
  
  @@unique([azure_credential_id, alert_id])
  @@index([organization_id])
  @@index([severity])
  @@index([status])
  @@index([start_time])
  @@map("azure_defender_findings")
}

// ==================== AZURE RESERVATIONS ====================
// Equivalent to AWS Reserved Instances

model AzureReservation {
  id                    String   @id @default(uuid()) @db.Uuid
  organization_id       String   @db.Uuid
  azure_credential_id   String   @db.Uuid
  reservation_id        String   @unique
  reservation_order_id  String?
  display_name          String?
  sku_name              String?
  sku_description       String?
  location              String?
  quantity              Int?
  term                  String?
  billing_scope_id      String?
  provisioning_state    String?
  effective_date        DateTime? @db.Timestamptz(6)
  expiry_date           DateTime? @db.Timestamptz(6)
  utilization_percentage Float?
  benefit_start_time    DateTime? @db.Timestamptz(6)
  last_updated_time     DateTime? @db.Timestamptz(6)
  applied_scope_type    String?
  applied_scopes        String[]
  renew                 Boolean  @default(false)
  metadata              Json?
  created_at            DateTime @default(now()) @db.Timestamptz(6)
  updated_at            DateTime @updatedAt @db.Timestamptz(6)
  
  azure_credential      AzureCredential @relation(fields: [azure_credential_id], references: [id], onDelete: Cascade)
  
  @@index([organization_id])
  @@index([azure_credential_id])
  @@index([expiry_date])
  @@index([utilization_percentage])
  @@map("azure_reservations")
}

// ==================== AZURE WAF EVENTS ====================
// Equivalent to AWS WAF Events for Azure Front Door/WAF

model AzureWafEvent {
  id                  String   @id @default(uuid()) @db.Uuid
  organization_id     String   @db.Uuid
  azure_credential_id String   @db.Uuid
  timestamp           DateTime @db.Timestamptz(6)
  action              String
  source_ip           String
  country             String?
  region              String?
  user_agent          String?
  uri                 String?
  http_method         String?
  rule_matched        String?
  threat_type         String?
  severity            String   @default("low")
  raw_log             Json?
  created_at          DateTime @default(now()) @db.Timestamptz(6)
  
  azure_credential    AzureCredential @relation(fields: [azure_credential_id], references: [id], onDelete: Cascade)
  
  @@index([organization_id])
  @@index([azure_credential_id])
  @@index([timestamp])
  @@index([source_ip])
  @@index([severity])
  @@map("azure_waf_events")
}

// ==================== DEMO MODE AUDIT ====================
// Auditoria de todas as mudanças no modo de demonstração

model DemoModeAudit {
  id              String   @id @default(uuid()) @db.Uuid
  organization_id String   @db.Uuid
  action          String   // ACTIVATED, DEACTIVATED, EXTENDED, EXPIRED
  performed_by    String?  @db.Uuid
  previous_state  Json?
  new_state       Json?
  reason          String?
  ip_address      String?
  user_agent      String?
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  
  organization    Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  
  @@index([organization_id])
  @@index([created_at])
  @@map("demo_mode_audit")
}


// ==================== AI PROACTIVE NOTIFICATIONS ====================
// Sistema de notificações proativas da IA para usuários

model AiNotificationRule {
  id              String   @id @default(uuid()) @db.Uuid
  
  // Identificação da regra
  rule_type       String   @unique // 'security_scan_needed', 'compliance_scan_needed', etc.
  name            String   // Nome amigável da regra
  description     String?  // Descrição do que a regra faz
  
  // Configuração
  is_enabled      Boolean  @default(true)
  priority        String   @default("medium") // 'low', 'medium', 'high', 'critical'
  
  // Parâmetros da regra (JSON)
  // Ex: { "days_threshold": 7, "critical_threshold": 14 }
  parameters      Json?
  
  // Template da notificação
  title_template  String   // Ex: "Scan de Segurança Recomendado"
  message_template String  // Ex: "Faz {days} dias desde o último scan..."
  suggested_action_template String? // Ex: "Posso iniciar o scan agora?"
  action_type     String?  // 'security_scan', 'compliance_scan', etc.
  
  // Controle de execução
  last_executed_at DateTime? @db.Timestamptz(6)
  execution_count Int      @default(0)
  
  // Auditoria
  created_by      String?  @db.Uuid
  updated_by      String?  @db.Uuid
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  updated_at      DateTime @updatedAt @db.Timestamptz(6)
  
  @@index([is_enabled])
  @@index([rule_type])
  @@map("ai_notification_rules")
}

model AiNotification {
  id              String   @id @default(uuid()) @db.Uuid
  organization_id String   @db.Uuid
  user_id         String?  @db.Uuid  // null = todos os usuários da org
  
  // Tipo e prioridade
  type            String   // 'security_scan_needed', 'cost_alert', 'compliance_due', 'custom', etc.
  priority        String   @default("medium") // 'low', 'medium', 'high', 'critical'
  
  // Conteúdo da mensagem
  title           String
  message         String   // Mensagem que a IA vai "falar"
  suggested_action String? // Ex: "Posso iniciar o scan de segurança para você?"
  action_type     String?  // 'security_scan', 'compliance_scan', 'cost_analysis', 'navigate', etc.
  action_params   Json?    // Parâmetros para a ação
  
  // Contexto
  context         Json?    // Dados adicionais (ex: dias desde último scan)
  
  // Status
  status          String   @default("pending") // 'pending', 'delivered', 'read', 'actioned', 'dismissed'
  delivered_at    DateTime? @db.Timestamptz(6)
  read_at         DateTime? @db.Timestamptz(6)
  actioned_at     DateTime? @db.Timestamptz(6)
  dismissed_at    DateTime? @db.Timestamptz(6)
  
  // Controle de expiração
  expires_at      DateTime? @db.Timestamptz(6)
  
  // Quem criou (para notificações manuais do admin)
  created_by      String?  @db.Uuid
  
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  updated_at      DateTime @updatedAt @db.Timestamptz(6)
  
  @@index([organization_id, status])
  @@index([organization_id, user_id, status])
  @@index([expires_at])
  @@index([type])
  @@index([priority])
  @@map("ai_notifications")
}


// ==================== EMAIL NOTIFICATION SYSTEM ====================
// Sistema de templates de email e configurações por organização

model EmailTemplate {
  id              String   @id @default(uuid()) @db.Uuid
  template_type   String   @unique // 'welcome', 'daily_summary', 'weekly_report', 'critical_alert', etc.
  name            String
  description     String?
  subject         String
  html_body       String   @db.Text
  text_body       String?  @db.Text
  variables       String[] @default([]) // Variables that can be used in template
  category        String   @default("general") // 'onboarding', 'reports', 'alerts', 'security', 'costs', 'ai'
  is_active       Boolean  @default(true)
  is_system       Boolean  @default(false) // System templates cannot be deleted
  created_by      String?  @db.Uuid
  updated_by      String?  @db.Uuid
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  updated_at      DateTime @updatedAt @db.Timestamptz(6)
  
  @@index([template_type])
  @@index([category])
  @@index([is_active])
  @@map("email_templates")
}

model OrganizationEmailSettings {
  id                String   @id @default(uuid()) @db.Uuid
  organization_id   String   @db.Uuid
  notification_type String   // 'daily_summary', 'weekly_report', 'critical_alert', etc.
  is_enabled        Boolean  @default(true)
  frequency         String   @default("daily") // 'immediate', 'daily', 'weekly', 'monthly'
  send_time         DateTime? @db.Time // Preferred time to send (for scheduled emails)
  timezone          String   @default("America/Sao_Paulo")
  recipients        String[] @default([]) // Additional recipients (empty = org admins)
  last_sent_at      DateTime? @db.Timestamptz(6)
  next_scheduled_at DateTime? @db.Timestamptz(6)
  send_count        Int      @default(0)
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  updated_at        DateTime @updatedAt @db.Timestamptz(6)
  
  @@unique([organization_id, notification_type])
  @@index([organization_id])
  @@index([notification_type])
  @@index([is_enabled])
  @@index([next_scheduled_at])
  @@map("organization_email_settings")
}

// ==================== RESOURCE COMMENTS ====================
// Comentários em recursos (findings, tickets, etc.)

model ResourceComment {
  id              String   @id @default(uuid()) @db.Uuid
  organization_id String   @db.Uuid
  resource_type   String
  resource_id     String
  user_id         String   @db.Uuid
  content         String
  parent_id       String?  @db.Uuid
  mentions        Json?
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  updated_at      DateTime @default(now()) @db.Timestamptz(6)
  
  mention_notifications MentionNotification[]
  
  @@index([organization_id])
  @@index([resource_type, resource_id])
  @@map("resource_comments")
}

// ==================== MENTION NOTIFICATIONS ====================
// Notificações de menções em comentários

model MentionNotification {
  id              String   @id @default(uuid()) @db.Uuid
  organization_id String   @db.Uuid
  user_id         String   @db.Uuid
  comment_id      String   @db.Uuid
  is_read         Boolean  @default(false)
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  
  comment         ResourceComment @relation(fields: [comment_id], references: [id], onDelete: Cascade)
  
  @@index([user_id])
  @@index([is_read])
  @@map("mention_notifications")
}

// ==================== EVO APP CREDENTIALS (Platform-level) ====================

model EvoAppCredential {
  id                    String    @id @default(uuid())
  provider              String    @default("azure")
  client_id             String
  client_secret_masked  String?
  secret_expires_at     DateTime?
  redirect_uri          String?
  ssm_synced_at         DateTime?
  lambdas_synced_at     DateTime?
  lambdas_synced_count  Int?      @default(0)
  notes                 String?
  updated_by            String?
  created_at            DateTime  @default(now())
  updated_at            DateTime  @default(now()) @updatedAt

  @@unique([provider, client_id])
  @@map("evo_app_credentials")
}

// ==================== CLOUD BUDGETS ====================

model CloudBudget {
  id              String   @id @default(uuid()) @db.Uuid
  organization_id String   @db.Uuid
  cloud_provider  String   @default("AWS")
  account_id      String?  // UUID da conta (aws_credentials.id ou azure_credentials.id)
  year_month      String   // formato: '2026-02'
  amount          Float    @default(0)
  currency        String   @default("USD")
  source          String   @default("auto") // 'auto' ou 'manual'
  created_by      String?  // user_id
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  updated_at      DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@unique([organization_id, cloud_provider, account_id, year_month])
  @@index([organization_id])
  @@index([year_month])
  @@index([account_id])
  @@map("cloud_budgets")
}

// ==================== EMAIL DELIVERY TRACKING ====================
// Rastreamento de entrega de emails via SES Event Publishing

model EmailEvent {
  id              String   @id @default(uuid()) @db.Uuid
  organization_id String?  @db.Uuid
  message_id      String   // SES MessageId
  event_type      String   // Send, Delivery, Bounce, Complaint, Reject, Open, Click
  recipient       String   // Email do destinatário
  sender          String?  // Email do remetente
  subject         String?
  bounce_type     String?  // Permanent, Transient
  bounce_sub_type String?  // General, NoEmail, Suppressed, etc.
  complaint_type  String?  // abuse, auth-failure, fraud, etc.
  diagnostic      String?  // Mensagem de diagnóstico do servidor
  timestamp       DateTime @db.Timestamptz(6)
  raw_event       Json?    // Evento completo do SES para debug
  created_at      DateTime @default(now()) @db.Timestamptz(6)

  @@index([message_id])
  @@index([organization_id])
  @@index([recipient])
  @@index([event_type])
  @@index([timestamp])
  @@map("email_events")
}

// ==================== TAG SYSTEM ====================

enum TagCategory {
  COST_CENTER
  ENVIRONMENT
  TEAM
  PROJECT
  COMPLIANCE
  CRITICALITY
  CUSTOM

  @@map("tag_category")
}

model Tag {
  id              String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organization_id String      @db.Uuid
  key             String      @db.VarChar(64)
  value           String      @db.VarChar(128)
  color           String      @db.VarChar(7)
  category        TagCategory @default(CUSTOM)
  description     String?     @db.VarChar(256)
  parent_id       String?     @db.Uuid
  created_by      String      @db.Uuid
  created_at      DateTime    @default(now()) @db.Timestamptz(6)
  updated_at      DateTime    @updatedAt @db.Timestamptz(6)

  organization    Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  parent          Tag?         @relation("TagHierarchy", fields: [parent_id], references: [id], onDelete: SetNull)
  children        Tag[]        @relation("TagHierarchy")
  assignments     ResourceTagAssignment[]

  @@unique([organization_id, key, value], name: "uq_tag_org_key_value")
  @@index([organization_id, category])
  @@index([organization_id, key])
  @@index([parent_id])
  @@map("tags")
}

model TagPolicy {
  id                  String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organization_id     String   @unique @db.Uuid
  enforce_naming      Boolean  @default(true)
  prevent_duplicates  Boolean  @default(true)
  require_category    Boolean  @default(false)
  alert_low_coverage  Boolean  @default(true)
  coverage_threshold  Int      @default(80)
  alert_untagged_new  Boolean  @default(false)
  required_keys       String[] @default(["environment", "cost-center", "team"])
  updated_by          String?  @db.Uuid
  created_at          DateTime @default(now()) @db.Timestamptz(6)
  updated_at          DateTime @updatedAt @db.Timestamptz(6)

  @@index([organization_id])
  @@map("tag_policies")
}

model TagAutoRule {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organization_id   String   @db.Uuid
  name              String   @db.VarChar(128)
  description       String?
  is_active         Boolean  @default(true)
  conditions        Json     @default("[]")
  tag_ids           String[] @db.Uuid
  last_run_at       DateTime? @db.Timestamptz(6)
  last_run_matched  Int?     @default(0)
  last_run_applied  Int?     @default(0)
  total_applied     Int      @default(0)
  created_by        String?  @db.Uuid
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  updated_at        DateTime @updatedAt @db.Timestamptz(6)

  organization      Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)

  @@index([organization_id])
  @@index([organization_id, is_active])
  @@map("tag_auto_rules")
}

model ResourceTagAssignment {
  id                  String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organization_id     String   @db.Uuid
  tag_id              String   @db.Uuid
  resource_id         String   @db.VarChar(512)
  resource_type       String   @db.VarChar(128)
  cloud_provider      String   @db.VarChar(10)
  resource_name       String?  @db.VarChar(256)
  resource_region     String?  @db.VarChar(64)
  aws_account_id      String?  @db.VarChar(12)
  azure_credential_id String?  @db.Uuid
  assigned_by         String   @db.Uuid
  assigned_at         DateTime @default(now()) @db.Timestamptz(6)

  organization        Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  tag                 Tag          @relation(fields: [tag_id], references: [id], onDelete: Cascade)

  @@unique([organization_id, tag_id, resource_id], name: "uq_assignment_org_tag_resource")
  @@index([organization_id, resource_id])
  @@index([organization_id, tag_id])
  @@index([organization_id, resource_type, cloud_provider])
  @@index([resource_id])
  @@map("resource_tag_assignments")
}
